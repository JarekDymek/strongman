<!DOCTYPE html>
<html lang="pl">
<head>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta charset="utf-8"/>
  <title>Strong Man v.11.0 Pl</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #28a745;
      --error-color: #e74c3c;
      --info-color: #f1c40f;
      --light-gray: #f8f9fa;
      --medium-gray: #ddd;
      --dark-gray: #333;
      --white: #ffffff;
      --shadow-light: 0 5px 15px rgba(0,0,0,0.07);
      --shadow-dark: 0 6px 12px rgba(0,0,0,0.15);
      --gemini-glow: 0 0 15px rgba(52, 152, 219, 0.6);
      /* STOPWATCH COLORS */
      --lap-btn-color: #00A99D;
      --reps-btn-color: #ED5454;
      --start-btn-color: #28a745;
    }

    body.dark {
      --light-gray: #333;
      --medium-gray: #666;
      --dark-gray: #ecf0f1;
      --white: #2c3e50;
      --primary-color: #ecf0f1;
      background-color: #2c3e50;
      color: #ecf0f1;
    }
    body.dark .event-meta-header,
    body.dark .header,
    body.dark .intro-container,
    body.dark .panel,
    body.dark .modal-box {
      background-color: #34495e;
    }
    body.dark th {
      background-color: #2c3e50;
    }
    body.dark input,
    body.dark textarea,
    body.dark select {
      background-color: #2c3e50;
      color: #ecf0f1;
      border-color: #555;
    }
    body.dark #fullscreenStopwatch { background-color: #2c3e50; color: #ecf0f1; }
    body.dark #fsExitBtn { color: #ecf0f1; }

    body.contrast {
      --light-gray: #000;
      --medium-gray: #888;
      --dark-gray: #ff0;
      --white: #000;
      --primary-color: #ff0;
      --secondary-color: #ff0;
      --success-color: #0f0;
      --error-color: #f00;
      --info-color: #ff0;
      background-color: #000;
      color: #ff0;
    }
    body.contrast .event-meta-header,
    body.contrast .header,
    body.contrast .intro-container,
    body.contrast .panel,
    body.contrast .modal-box {
      background-color: #000;
      border: 2px solid #ff0;
    }
    body.contrast th {
      background-color: #111;
    }
    body.contrast input,
    body.contrast textarea,
    body.contrast select {
      background-color: #000;
      color: #ff0;
      border: 2px solid #ff0;
    }
    body.contrast button {
      border: 2px solid #ff0;
    }
    body.contrast #fullscreenStopwatch { background-color: #000; color: #ff0; }
    body.contrast #fsExitBtn { color: #ff0; }


    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html {
      font-size: 18px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 15px;
      background-color: var(--light-gray);
      color: var(--dark-gray);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
      font-weight: 500;
    }

    .event-meta-header, .header, .intro-container, .panel {
      background: var(--white);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-light);
      margin-bottom: 20px;
      transition: background-color 0.3s;
    }

    .event-meta-inputs { display: flex; gap: 15px; flex-wrap: wrap; }
    .event-meta-inputs input { flex: 1; min-width: 200px; }
    .header { text-align: center; }

    #logoImg[src] { cursor: pointer; }
    .logo-container { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; flex-direction: column; }
    #logoImg { max-height: 250px; max-width: 100%; margin-bottom: 15px; }
    .logo-actions { display: flex; gap: 10px; margin-top: 10px; }

    .logo-btn {
      padding: 6px 12px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer;
      background: var(--primary-color); color: var(--white); transition: all 0.2s;
    }
    .logo-btn:hover { opacity: 0.9; }
    .header h1 { font-size: 2.4rem; margin: 0 0 10px 0; color: var(--primary-color); }
    h2 { color: var(--primary-color); margin-top: 0; font-size: 2rem; }
    h3 { margin-top: 25px; margin-bottom: 10px; font-size: 1.4rem; color: #555; text-align: center; }

    textarea, input, select {
      font-size: 1.1rem;
      padding: 12px; margin: 5px 0 10px 0; width: 100%;
      border: 1px solid var(--medium-gray); border-radius: 8px; background-color: var(--white);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      font-weight: 600;
    }
    textarea { height: 100px; }

    button {
      display: block; width: 100%; padding: 15px; font-size: 1.2rem;
      font-weight: 700;
      border: none;
      border-radius: 8px; cursor: pointer; background: linear-gradient(135deg, #27ae60, #219653);
      color: var(--white); margin: 15px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: all 0.2s ease;
    }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-dark); }
    button:active:not(:disabled) { transform: translateY(0); }
    button:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; transform: none; }

    #mainContent {
      display: none; background: var(--white); padding: 25px;
      border-radius: 12px; box-shadow: var(--shadow-light); margin-top: 20px;
    }

    .event-title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
    #eventTitle {
      font-size: 2rem; font-weight: 700; padding: 15px; border-radius: 8px; border: 2px dashed var(--medium-gray);
      background-color: var(--white); cursor: text; outline: none; width: 100%; text-align: center;
      flex-grow: 1;
    }
    .event-type-container { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    .type-btn {
      padding: 12px 15px; border-radius: 6px; cursor: pointer; background: #e0e0e0;
      border: none; font-size: 1rem; transition: all 0.2s ease-in-out; white-space: nowrap;
    }
    .type-btn.active {
        background: var(--success-color);
        color: var(--white);
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(39, 174, 96, 0.7);
    }

    .actions-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr auto;
        margin: 20px 0;
        align-items: stretch;
    }
    .actions-grid button {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        padding: 15px 10px;
        line-height: 1.2;
    }
    #generateEventNameBtn {
      aspect-ratio: 1/1;
      font-size: 1.8rem;
      padding: 10px;
    }


    #undo-redo-container {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
        margin: 20px 0;
    }
    #undo-redo-container button {
        margin: 0; font-size: 1.1rem; font-weight: 600; padding: 15px 10px;
    }

    #export-button-group {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
        margin: 20px 0;
    }
    #export-button-group button:nth-child(3) {
        grid-column: 1 / -1;
    }

    .security-panel .button-group {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
        margin: 20px 0;
    }

    #undoBtn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    #redoBtn { background: linear-gradient(135deg, #2980b9, #3498db); }

    #toggleTableWidthBtn {
        width: 100%;
        margin: 15px 0 10px;
        background: var(--secondary-color);
        font-weight: 600;
        font-size: 1.1rem;
        padding: 10px;
    }

    .table-wrapper {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        transition: box-shadow 0.3s;
    }
    .table-wrapper.expanded {
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 8px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        table-layout: fixed;
    }
    .table-wrapper.expanded table {
        table-layout: auto;
        width: auto;
        min-width: 100%;
    }

    th, td {
      padding: 14px 6px;
      text-align: center;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
      font-size: 1.1rem;
    }
    th {
      background-color: var(--light-gray);
      font-weight: 700;
      white-space: normal;
    }

    th:first-child, td:first-child {
        text-align: left;
        white-space: normal;
    }
    .table-wrapper.expanded td,
    .table-wrapper.expanded th {
        white-space: nowrap;
    }

    #resultsTable .resultInput { cursor: pointer; width: 95%; max-width: 85px; font-size: 1.2rem; font-weight: 700;}
    input.resultInput:read-only { background-color: #f3f4f6; cursor: not-allowed; opacity: 0.7; }

    .gold td:first-child::before { content: "🥇 "; } .silver td:first-child::before { content: "🥈 "; } .bronze td:first-child::before { content: "🥉 "; }

    .competitor-cell { display: flex; align-items: center; gap: 10px; }
    .competitor-cell > span { font-weight: 600; font-size: 1.15rem; }
    .competitor-photo-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid var(--medium-gray); flex-shrink: 0; cursor: pointer; }
    .info-icon { cursor: pointer; font-size: 18px; color: var(--secondary-color); user-select: none; }

    #notification-bar, .modal-overlay { position: fixed; z-index: 1000; }
    #notification-bar {
      top: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px;
      color: var(--white); font-weight: bold; box-shadow: var(--shadow-dark); transition: top 0.4s ease-in-out;
      max-width: 90%; text-align: center;
    }
    #notification-bar.show { top: 20px; }
    #notification-bar.success { background-color: var(--success-color); }
    #notification-bar.error { background-color: var(--error-color); }
    #notification-bar.info { background-color: var(--info-color); color: var(--dark-gray); }

    .modal-overlay {
      top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6);
      display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, align-items 0.3s;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-box {
        background-color: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        max-width: 90%; width: 500px; text-align: center; max-height: 90vh; overflow-y: auto; position: relative;
        transition: margin-top 0.3s ease-out;
    }
    .modal-box p { margin: 0 0 20px 0; font-size: 1.125rem; }
    .modal-buttons { display: flex; gap: 15px; justify-content: center; }
    .modal-buttons button { width: auto; padding: 10px 25px; margin: 0; font-size: 1rem; }
    #confirmBtn, #promptConfirmBtn { background: var(--success-color); }
    #cancelBtn, #promptCancelBtn { background: var(--error-color); }

    .modal-overlay.keyboard-active {
        align-items: flex-start;
    }
    .modal-overlay.keyboard-active .focus-mode-box {
        height: auto;
        margin-top: 2vh;
    }
    
    /* NEW STYLES FOR LAP TIMES */
    #fsLapsModalList {
        max-height: 50vh;
        overflow-y: auto;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        margin-bottom: 20px;
    }
    #fsLapsModalList .lap-item {
        padding: 15px;
        font-size: 1.5rem;
        font-weight: 600;
        border-bottom: 1px solid var(--medium-gray);
        cursor: pointer;
        transition: background-color 0.2s;
        text-align: center;
    }
    #fsLapsModalList .lap-item:hover {
        background-color: #eef;
    }
    #fsLapsModalList .lap-item:last-child {
        border-bottom: none;
    }
    /* END OF NEW STYLES */

    #competitorDetailModal .modal-box { text-align: left; }
    #competitorDetailPhoto { max-width: 150px; border-radius: 8px; margin: 0 auto 20px; display: block; box-shadow: var(--shadow-dark); }
    #competitorDetailNotes { background-color: #f9f9f9; padding: 15px; border-radius: 8px; min-height: 80px; white-space: pre-wrap; font-size: 1rem; }
    #competitorDetailMeta { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; font-size: 1rem;}
    #competitorDetailMeta p { margin: 0; padding: 5px; border-bottom: 1px solid #eee;}
    #competitorDetailMeta p strong { color: var(--primary-color); }

    @keyframes highlight-flash-anim { 0%, 100% { background-color: transparent; } 50% { background-color: rgba(46, 204, 113, 0.3); } }
    .highlight-flash { animation: highlight-flash-anim 1s ease-out; }

    .tie-info { display: inline-block; margin-left: 8px; font-weight: bold; color: var(--secondary-color); cursor: pointer; position: relative; }
    .tie-info .tooltip {
        visibility: hidden; width: 220px; background-color: var(--primary-color); color: var(--white); text-align: center;
        border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%;
        margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-weight: normal; pointer-events: none;
    }
    .tie-info .tooltip::after {
        content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px;
        border-style: solid; border-color: var(--primary-color) transparent transparent transparent;
    }
    .tie-info.tooltip-active .tooltip { visibility: visible; opacity: 1; }

    #competitorDbPanel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
    #competitorDbPanel .modal-box { max-width: 800px; }
    #competitorListContainer { max-height: 35vh; overflow-y: auto; margin-top: 20px; border: 1px solid var(--medium-gray); border-radius: 8px; }
    .competitor-list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    .competitor-list-item span { font-size: 1.1rem; }
    .competitor-list-item:last-child { border-bottom: none; }
    .competitor-list-actions button { font-size: 14px; padding: 5px 10px; width: auto; margin: 0 5px; }
    #competitorForm .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    #competitorForm label { text-align: left; margin-bottom: -5px; font-size: 1rem; color: #555; display: block; }
    #dbManagementButtons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .categories-checkbox-group { display: flex; gap: 20px; align-items: center; padding: 10px 0; }
    .categories-checkbox-group label { display: flex; align-items: center; gap: 5px; font-size: 1.1rem; }
    .categories-checkbox-group input { width: auto; margin-right: 5px;}

    .intro-container .filter-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
    }
    .intro-container .filter-btn {
        padding: 10px 15px; font-size: 1rem; border: 1px solid var(--medium-gray);
        border-radius: 20px; background-color: var(--white); color: var(--primary-color);
        cursor: pointer; transition: all 0.2s;
    }
    .intro-container .filter-btn.active { background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color); }

    #competitorSelectionList { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; max-height: 40vh; overflow-y: auto; padding-top: 10px; border: 1px solid var(--medium-gray); border-radius: 8px; padding: 10px;}
    .competitor-select-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9f9f9; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
    .competitor-select-item span { font-size: 1.1rem; }
    .competitor-select-item:hover { background: #eef; }
    .competitor-select-item input[type="checkbox"] { width: 20px; height: 20px; flex-shrink: 0; }
    #addPastedBtn { background: var(--secondary-color); font-size: 1rem; padding: 12px; margin-top: 5px; }

    #selectionCounter {
        text-align: right; font-size: 1.1rem; font-weight: 700;
        color: var(--primary-color); margin-top: 15px; padding: 10px;
        background-color: #e9ecef; border-radius: 8px;
    }

    #competitorSearchContainer { position: relative; margin-top: 15px;}
    #competitorSearchResults { position: absolute; background: white; width: 100%; border: 1px solid var(--medium-gray); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: var(--shadow-dark); }
    .search-result-item { padding: 10px; cursor: pointer; }
    .search-result-item:hover { background-color: #eef; }


    .focus-mode-box { max-width: 100%; width: 100%; height: 100%; max-height: 100vh; border-radius: 0; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
    #focusCompetitorInfo { margin-bottom: 20px; text-align: center; }
    #focusCompetitorPhoto { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--secondary-color); margin-bottom: 15px; }
    #focusCompetitorName { font-size: 2rem; color: var(--primary-color); margin: 0; }
    #focusResultInput { font-size: 3.5rem; text-align: center; padding: 20px; margin-bottom: 20px; border-width: 2px; }
    .focus-nav-buttons { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; }
    .focus-nav-buttons button { padding: 15px; font-size: 1.1rem; }
    #focusConfirmNextBtn { background: var(--success-color); }
    #focusPrevBtn, #focusNextBtn { background: var(--secondary-color); }
    .focus-close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 2.5rem; color: var(--dark-gray); cursor: pointer; padding: 0; width: auto; margin: 0; box-shadow: none; }

    .security-panel { margin-top: 25px; padding-top: 20px; border-top: 2px solid var(--medium-gray); }
    .security-panel h3 { text-align: left; }

    #checkpointList {
        display: flex;
        flex-direction: column;
        gap: 0;
    }
    #checkpointList button {
        font-size: 1rem;
        background: #f0f0f0;
        color: #333;
        margin: 8px 0;
        width: 100%;
        text-align: left;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        line-height: 1.4;
        cursor: pointer;
    }
    #checkpointList button:hover {
        background: #e0e0e0;
    }
    #checkpointList button small {
        font-size: 0.85rem;
        color: #555;
    }

    #saveIndicator {
        position: fixed; top: 20px; right: 20px; font-size: 24px;
        opacity: 0; transition: opacity 0.5s ease-in-out;
        z-index: 2000; pointer-events: none;
    }
    #saveIndicator.visible { opacity: 1; }

    .theme-selector {
      position: absolute; top: 20px; right: 20px; background: var(--white);
      padding: 8px 12px; border-radius: 6px; box-shadow: var(--shadow-light);
    }

    .gemini-btn {
        background: linear-gradient(135deg, #4e54c8, #8f94fb);
        box-shadow: 0 0 10px var(--gemini-glow);
        margin: 0;
    }
    .gemini-btn-small {
        background: linear-gradient(135deg, #4e54c8, #8f94fb);
        padding: 0;
        font-size: 1.5rem;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        box-shadow: 0 0 8px var(--gemini-glow);
        margin: 0 0 0 10px;
        width: 2.5rem;
        height: 2.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        flex-shrink: 0;
    }
    #gemini-output textarea {
      width: 100%;
      height: 200px;
      margin-top: 15px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      font-size: 1rem;
      resize: vertical;
    }
    body.dark #gemini-output textarea {
        background-color: #2c3e50;
        color: #ecf0f1;
        border-color: #555;
    }
    #gemini-output button {
        margin: 8px 0;
        font-size: 1rem;
    }

    .result-cell { display: flex; align-items: center; justify-content: center; gap: 5px; }

    /* --- FULLSCREEN STOPWATCH STYLES --- */
    #fullscreenStopwatch {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100dvh; /* Dynamic viewport height */
        background-color: var(--white);
        color: var(--dark-gray);
        z-index: 5000;
        display: none;
        flex-direction: column;
        justify-content: space-between;
        padding: 20px;
        font-weight: 700;
        text-transform: uppercase;
    }
    #fullscreenStopwatch.visible {
        display: flex;
    }

    #fsExitBtn {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 3rem;
        color: var(--dark-gray);
        text-decoration: none;
        z-index: 10;
        font-weight: bold;
    }

    #fsDisplayArea {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        text-align: center;
        cursor: pointer; /* Make it obvious it's clickable */
    }

    #fsTime {
        font-family: 'monospace';
        font-size: clamp(4rem, 20vw, 10rem);
        line-height: 1;
        margin-bottom: 15px;
    }

    #fsCompetitorPhoto {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        background-color: var(--medium-gray);
        border: 4px solid var(--secondary-color);
        margin-bottom: 15px;
    }

    #fsCompetitorName {
        font-size: clamp(1.8rem, 6vw, 3.5rem);
        font-weight: 600;
        margin-bottom: 15px;
    }

    #fsRepsDisplay {
        font-size: clamp(2.5rem, 8vw, 5rem);
        color: var(--reps-btn-color);
        margin-top: 15px;
        display: none; /* Hidden by default */
    }

    #fsControls {
        flex-shrink: 0;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    #fsModeSelection {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        flex-grow: 1;
        min-height: 80px;
    }

    .fs-btn {
        width: 100%;
        height: 100%;
        border: none;
        color: white;
        font-size: clamp(1.8rem, 5vw, 2.5rem);
        font-weight: 700;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        text-transform: uppercase;
        padding: 15px;
        margin: 0;
        border-radius: 20px;
        user-select: none;
        transition: transform 0.1s ease, filter 0.2s, box-shadow 0.2s;
    }
    .fs-btn:active:not(:disabled) {
        transform: scale(0.97);
    }
    .fs-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    #fsRepsBtn { background: var(--reps-btn-color); }
    #fsLapsBtn { background: var(--lap-btn-color); }
    
    #fullscreenStopwatch.mode-selected #fsRepsBtn:not(.selected) { display: none; }
    #fullscreenStopwatch.mode-selected #fsLapsBtn:not(.selected) { display: none; }
    #fullscreenStopwatch.mode-selected #fsModeSelection {
        grid-template-columns: 1fr; 
    }

    #fsStartStopBtn {
        background: var(--start-btn-color);
        font-size: clamp(2.5rem, 8vw, 4rem);
        min-height: 110px;
        padding: 20px;
        width: 100%;
        aspect-ratio: 1 / 1; 
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }
    #fsStartStopBtn.stop-state {
        background: var(--error-color);
    }

    #fsPostStopControls {
        display: none;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        width: 100%;
        min-height: 90px;
    }
    #fsResetBtn { background: var(--secondary-color); }
    #fsSaveBtn { background: var(--success-color); }

    @media (max-width: 768px) {
      html { font-size: 14px; }
      body { padding: 10px; }
      .event-meta-header, .header, .intro-container, .panel { padding: 15px; }
      #eventTitle { font-size: 1.5rem; }
      .event-title-container { flex-direction: column; align-items: stretch; }
      #competitorForm .form-grid { grid-template-columns: 1fr; }
      .modal-box { width: 95%; }
      .theme-selector { position: static; margin: 10px auto; width: fit-content; }
    }
  </style>
</head>
<body>

  <div id="notification-bar"></div>
  <div id="saveIndicator">💾</div>

  <div id="confirmationModal" class="modal-overlay">
    <div class="modal-box">
      <p id="modalText"></p>
      <div class="modal-buttons">
        <button id="confirmBtn">Tak</button> <button id="cancelBtn">Anuluj</button>
      </div>
    </div>
  </div>
  <div id="promptModal" class="modal-overlay">
      <div class="modal-box">
          <p id="promptText"></p>
          <input type="text" id="promptInput" placeholder="Wprowadź nazwę...">
          <div class="modal-buttons">
              <button id="promptConfirmBtn">Zapisz</button>
              <button id="promptCancelBtn">Anuluj</button>
          </div>
      </div>
  </div>
  <div id="geminiModal" class="modal-overlay">
    <div class="modal-box">
      <h3 id="geminiModalTitle">✨ Sugestie od Gemini</h3>
      <div id="geminiLoading" style="display: none; font-size: 1.2rem; padding: 20px 0;">Generowanie...</div>
      <div id="geminiOutput"></div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button id="geminiCloseBtn">Zamknij</button>
      </div>
    </div>
  </div>
  <div id="fsLapsModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Wybierz wynik do zapisu</h3>
        <div id="fsLapsModalList"></div>
        <button onclick="document.getElementById('fsLapsModal').classList.remove('visible')" style="background-color: var(--error-color);">Anuluj</button>
    </div>
  </div>


  <div id="competitorDetailModal" class="modal-overlay" onclick="this.classList.remove('visible')">
      <div class="modal-box" onclick="event.stopPropagation()">
          <h3 id="competitorDetailName" style="text-align: center;"></h3>
          <img id="competitorDetailPhoto" src="" alt="Zdjęcie zawodnika">
          <div id="competitorDetailMeta"></div>
          <h4>Osiągnięcia / Notatki:</h4>
          <p id="competitorDetailNotes"></p>
          <button onclick="document.getElementById('competitorDetailModal').classList.remove('visible')" style="font-size: 16px; padding: 10px;">Zamknij</button>
      </div>
  </div>
  <div id="competitorDbPanel">
    <div class="modal-box">
      <h2>Baza Danych Zawodników</h2>
      <form id="competitorForm">
        <input type="hidden" id="competitorId">
        <label for="competitorName">Imię i nazwisko</label>
        <input type="text" id="competitorName" placeholder="Imię i nazwisko" required>

        <div class="form-grid">
            <div><label for="birthDate">Data urodzenia</label><input type="date" id="birthDate"></div>
            <div><label for="residence">Miejsce zamieszkania</label><input type="text" id="residence" placeholder="np. Malbork"></div>
            <div><label for="height">Wzrost (cm)</label><input type="number" id="height" placeholder="np. 186"></div>
            <div><label for="weight">Waga (kg)</label><input type="number" id="weight" placeholder="np. 140"></div>
        </div>

        <label>Kategorie</label>
        <div id="competitorCategories" class="categories-checkbox-group">
          <label><input type="checkbox" name="category" value="Legend"> Legenda</label>
          <label><input type="checkbox" name="category" value="Polish Cup"> Puchar Polski</label>
        </div>

        <label for="competitorNotes">Osiągnięcia / Notatki</label>
        <textarea id="competitorNotes" placeholder="Główne osiągnięcia, rekordy, informacje..."></textarea>

        <label for="competitorPhoto">Zdjęcie</label>
        <input type="file" id="competitorPhoto" accept="image/*">

        <button type="submit" id="competitorFormBtn">Dodaj Zawodnika</button>
      </form>
      <div id="competitorListContainer"></div>

      <div id="dbManagementButtons">
        <button onclick="exportCompetitorDb()" style="background: var(--info-color); color: var(--dark-gray);">Eksportuj Bazę</button>
        <button onclick="document.getElementById('importDbFile').click()" style="background: var(--info-color); color: var(--dark-gray);">Importuj Bazę</button>
        <input type="file" id="importDbFile" accept=".json" style="display:none;" onchange="handleDbFileImport(event)">
      </div>

      <button onclick="closeDbPanel()" style="background: var(--primary-color); margin-top: 20px;">Zamknij Panel</button>
    </div>
  </div>
  <div id="focusModeModal" class="modal-overlay">
      <div class="modal-box focus-mode-box">
          <button id="closeFocusBtn" class="focus-close-btn" aria-label="Zamknij tryb skupienia">×</button>
          <div id="focusCompetitorInfo">
              <img id="focusCompetitorPhoto" src="" alt="Zdjęcie zawodnika">
              <h3 id="focusCompetitorName"></h3>
          </div>
          <input type="text" inputmode="text" id="focusResultInput" placeholder="Wpisz wynik...">
          <div class="focus-nav-buttons">
              <button id="focusPrevBtn">Poprzedni</button>
              <button id="focusConfirmNextBtn">Zatwierdź i Następny</button>
              <button id="focusNextBtn">Następny</button>
          </div>
      </div>
  </div>

  <div id="fullscreenStopwatch">
    <a href="#" id="fsExitBtn">×</a>
    <div id="fsDisplayArea">
      <div id="fsTime">00:00.00</div>
      <img id="fsCompetitorPhoto" src="" alt="Zdjęcie zawodnika">
      <div id="fsCompetitorName">Zawodnik</div>
      <div id="fsRepsDisplay">0 Powt.</div>
    </div>
    <div id="fsControls">
      <div id="fsModeSelection">
        <button id="fsRepsBtn" class="fs-btn">Powtórzenia</button>
        <button id="fsLapsBtn" class="fs-btn">Międzyczasy</button>
      </div>
      <button id="fsStartStopBtn" class="fs-btn">Start</button>
      <div id="fsPostStopControls">
        <button id="fsResetBtn" class="fs-btn">Reset</button>
        <button id="fsSaveBtn" class="fs-btn">Zapisz</button>
      </div>
    </div>
</div>

  <div class="theme-selector">
    <label for="themeSelector">Motyw:</label>
    <select id="themeSelector">
      <option value="light">Jasny</option>
      <option value="dark">Ciemny</option>
      <option value="contrast">Kontrastowy</option>
    </select>
  </div>

  <div class="event-meta-header">
    <div class="event-meta-inputs">
      <input type="text" id="eventNameInput" placeholder="Nazwa zawodów">
      <input type="text" id="eventLocationInput" placeholder="Lokalizacja zawodów">
    </div>
    <div class="actions-grid">
        <button onclick="openDbPanel()">Zarządzaj Bazą Zawodników</button>
        <button id="generateEventNameBtn" class="gemini-btn" title="Zaproponuj nazwę zawodów">✨</button>
    </div>
  </div>

  <div class="header">
    <div class="logo-container">
      <img id="logoImg" src="" alt="Logo zawodów">
      <div class="logo-actions">
        <button id="selectLogoBtn" class="logo-btn" onclick="document.getElementById('logoUpload').click()">Wybierz Logo</button>
      </div>
      <input type="file" id="logoUpload" accept="image/*" style="display:none" onchange="handleLogoUpload(event)">
    </div>
    <h1>🏋️‍♂️ ZAWODY STRONGMAN 🏋️‍♀️</h1>
    <p>System Zarządzania</p>
  </div>

  <div id="intro">
    <div class="intro-container">
      <h2>Wybierz Zawodników</h2>
      <p>Filtruj wg kategorii, aby zawęzić listę. Wybory są zachowywane pomiędzy filtrami.</p>

      <div class="filter-buttons" id="categoryFilters">
        <button class="filter-btn active" data-filter="all">Wszyscy</button>
        <button class="filter-btn" data-filter="Legend">Legendy</button>
        <button class="filter-btn" data-filter="Polish Cup">Puchar Polski</button>
      </div>

      <div id="competitorSelectionList">
        <p>Ładowanie zawodników z bazy danych...</p>
      </div>
      <div id="selectionCounter">Wybrano: 0</div>

      <div id="competitorSearchContainer">
        <input type="text" id="competitorSearch" placeholder="Wyszukaj i dodaj zawodnika z bazy...">
        <div id="competitorSearchResults"></div>
      </div>

      <h3>...lub wklej listę zawodników</h3>
      <textarea id="pastedCompetitors" placeholder="Wklej listę zawodników, jeden w każdej linii..."></textarea>
      <button id="addPastedBtn">Dodaj Zawodników z Listy</button>


<div class="security-panel">
  <h3>🛡️ Zabezpieczenia Przed Startem</h3>
  <div class="button-group">
    <button onclick="exportStateToFile()">Eksportuj Stan do Pliku</button>
    <button onclick="importStateFromFile()">Importuj Stan z Pliku</button>
  </div>
  <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleFileImport(event)">
</div>

<button onclick="startCompetition()">Rozpocznij Zawody</button>
    </div>
  </div>

  <div id="mainContent">
    <div class="event-title-container">
      <div id="eventTitle" contenteditable="true">Konkurencja 1</div>
      <button id="generateAnnounceBtn" class="gemini-btn-small" title="Generuj zapowiedź konkurencji (AI Gemini)">✨</button>
    </div>
    <div class="event-type-container">
        <button id="highTypeBtn" class="type-btn active" onclick="setEventType('high')">⬆️ Więcej = Lepiej</button>
        <button id="lowTypeBtn" class="type-btn" onclick="setEventType('low')">⬇️ Mniej = Lepiej</button>
    </div>

    <div class="actions-grid">
      <button onclick="shuffleCompetitors()">Pomieszaj</button>
      <button onclick="showResults()">Wyniki</button>
      <button onclick="nextEvent()">Następna Konkurencja</button>
      <button onclick="finalEvent()">Konkurencja Finałowa</button>
      <button onclick="calculatePoints()">Przyznaj Punkty</button>
      <button onclick="showFinalSummary()">Podsumowanie</button>
    </div>

    <button id="toggleTableWidthBtn">Pokaż Pełną Tabelę</button>
    <div class="table-wrapper">
        <table id="resultsTable">
          <thead>
            <tr><th>Zawodnik</th><th>Wynik</th><th>Miejsce</th><th>Pkt.</th><th>Suma</th></tr>
          </thead>
          <tbody></tbody>
        </table>
    </div>

    <div id="undo-redo-container">
        <button id="undoBtn" onclick="undoLastAction()" disabled>Cofnij</button>
        <button id="redoBtn" onclick="redoLastAction()" disabled>Ponów</button>
    </div>

    <div class="panel" id="historyPanel" style="display:none;">
      <h3>Historia Konkurencji</h3>
      <div id="eventList"></div>
      <div class="panel" id="eventDetails"></div>
    </div>

    <div id="export-button-group">
      <button onclick="exportResultsHTML()">Eksportuj HTML</button>
      <button onclick="exportToPDF()">Eksportuj do PDF</button>
      <button onclick="resetCompetition()" style="background:var(--error-color)">Resetuj</button>
    </div>

    <div class="panel security-panel">
        <h3>🛡️ Zabezpieczenia i Kopie Zapasowe</h3>
        <div class="button-group">
            <button onclick="saveCheckpoint()">Zapisz Punkt Kontrolny</button>
            <button onclick="showCheckpoints()">Wczytaj Punkt Kontrolny</button>
            <button onclick="exportStateToFile()">Eksportuj Stan do Pliku</button>
            <button onclick="importStateFromFile()">Importuj Stan z Pliku</button>
        </div>
        <input type="file" id="importFile2" accept=".json" style="display:none;" onchange="handleFileImport(event)">
        <div id="checkpointListContainer" style="display:none; margin-top:15px;">
            <h4>Dostępne punkty kontrolne:</h4>
            <div id="checkpointList"></div>
        </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // GLOBAL STATE
    let competitors = [], scores = {}, eventNumber = 1, eventHistory = [], logoData = null, currentEventType = 'high';
    let undoHistory = [], redoHistory = [];
    let db;
    let allDbCompetitors = [];
    let competitorProfiles = {};
    let focusModeIndex = -1;
    let autoSaveTimer;

    // STOPWATCH STATE
    let stopwatchInterval = null;
    let stopwatchStartTime = 0;
    let stopwatchElapsedTime = 0;
    let currentStopwatchCompetitor = null;
    let isStopwatchRunning = false;
    let stopwatchCheckpointCounter = 1;
    let stopwatchMode = 'none'; // 'none', 'reps', 'laps'
    let repCount = 0;
    let lapTimes = [];


    const CHECKPOINT_PREFIX = 'strongman_checkpoint_';

    // --- DATABASE (IndexedDB) ---
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("StrongmanDB_v4", 1);
        request.onerror = e => { showNotification("Błąd otwierania bazy danych: " + e.target.error, "error"); reject(e); };
        request.onsuccess = e => { db = e.target.result; resolve(); };
        request.onupgradeneeded = e => {
          let db = e.target.result;
          if (!db.objectStoreNames.contains('competitors')) {
            const store = db.createObjectStore('competitors', { keyPath: 'id', autoIncrement: true });
            store.createIndex('name', 'name', { unique: true });
          }
        };
      });
    }

    async function seedDatabaseIfNeeded() {
        const dbCompetitors = await getCompetitorsFromDb();
        if (dbCompetitors.length === 0) {
            showNotification('Wykryto pustą bazę danych. Wypełniam ją początkowymi polskimi zawodnikami...', 'info');
            const initialCompetitors = [
                { name: 'Mariusz Pudzianowski', categories: ['Legend'], notes: '5x Najsilniejszy Człowiek Świata', photo: 'https://placehold.co/150x150/2c3e50/ffffff?text=MP' },
                { name: 'Mateusz Kieliszkowski', categories: ['Legend', 'Polish Cup'], notes: 'Wielokrotny wicemistrz WSM i Arnold Strongman Classic', photo: 'https://placehold.co/150x150/e74c3c/ffffff?text=MK' },
                { name: 'Krzysztof Radzikowski', categories: ['Polish Cup'], notes: 'Zwycięzca Ligi Mistrzów Strongman 2013', photo: 'https://placehold.co/150x150/8e44ad/ffffff?text=KR' },
                { name: 'Oskar Ziółkowski', categories: ['Polish Cup'], notes: 'Mistrz Polski Strongman 2021', photo: 'https://placehold.co/150x150/34495e/ffffff?text=OZ' },
                { name: 'Marek Czajkowski', categories: ['Polish Cup'], notes: 'Mistrz Polski Strongman 2022, 2023', photo: 'https://placehold.co/150x150/7f8c8d/ffffff?text=MC' },
                { name: 'Jarosław Dymek', categories: ['Legend'], notes: '3x Mistrz Polski Strongman, zwycięzca WSM w drużynie', photo: 'https://placehold.co/150x150/5e8a80/ffffff?text=JD' },
                { name: 'Sebastian Wenta', categories: ['Legend'], notes: 'Wicemistrz WSM 2007', photo: 'https://placehold.co/150x150/8e44ad/ffffff?text=SW' }
            ];
            for (const competitor of initialCompetitors) {
                const fullCompetitor = {
                    name: competitor.name || 'Unknown',
                    categories: competitor.categories || [],
                    birthDate: '', residence: '', height: '', weight: '',
                    notes: competitor.notes || '',
                    photo: competitor.photo || `https://placehold.co/150x150/eee/333?text=${competitor.name.substring(0,1)}`
                };
                await addCompetitorToDb(fullCompetitor);
            }
        }
    }

    function dbAction(storeName, mode, action, data) {
      return new Promise((resolve, reject) => {
        if (!db) { reject("Database is not initialized."); return; }
        const transaction = db.transaction(storeName, mode);
        const store = transaction.objectStore(storeName);
        const request = action(store, data);
        transaction.oncomplete = () => {};
        request.onerror = e => reject(e);
        request.onsuccess = e => resolve(e.target.result);
      });
    }

    async function addCompetitorToDb(competitor) { return await dbAction('competitors', 'readwrite', (store, data) => store.add(data), competitor); }
    async function updateCompetitorInDb(competitor) { return await dbAction('competitors', 'readwrite', (store, data) => store.put(data), competitor); }
    async function deleteCompetitorFromDb(id) { return await dbAction('competitors', 'readwrite', (store, data) => store.delete(data), id); }
    async function getCompetitorsFromDb() { return await dbAction('competitors', 'readonly', (store) => store.getAll()); }

    function openDbPanel() { document.getElementById('competitorDbPanel').style.display = 'flex'; renderDbCompetitorList(); }
    function closeDbPanel() {
      document.getElementById('competitorDbPanel').style.display = 'none';
      document.getElementById('competitorForm').reset();
      document.getElementById('competitorId').value = '';
      document.getElementById('competitorFormBtn').textContent = 'Dodaj Zawodnika';
    }

    async function renderDbCompetitorList() {
      const dbCompetitors = (await getCompetitorsFromDb()).sort((a,b) => a.name.localeCompare(b.name));
      const container = document.getElementById('competitorListContainer');
      if (dbCompetitors.length === 0) {
        container.innerHTML = '<p style="padding: 20px; text-align:center;">Brak zawodników w bazie. Dodaj pierwszego!</p>';
        return;
      }
      container.innerHTML = dbCompetitors.map(c => {
        const categoriesText = (c.categories && c.categories.length > 0) ? c.categories.join(', ') : 'Brak';
        return `
            <div class="competitor-list-item">
            <div class="competitor-cell">
                <img src="${c.photo || 'https://placehold.co/40x40/eee/333?text=?'}" class="competitor-photo-thumb">
                <span>${c.name} <small>(${categoriesText})</small></span>
            </div>
            <div class="competitor-list-actions">
                <button onclick="editCompetitor(${c.id})">Edytuj</button>
                <button onclick="confirmDeleteCompetitor(${c.id})" style="background:var(--error-color);">Usuń</button>
            </div>
            </div>
        `}).join('');
    }

    async function populateFullCompetitorList() {
        allDbCompetitors = (await getCompetitorsFromDb()).sort((a, b) => a.name.localeCompare(b.name));

        allDbCompetitors.forEach(c => {
            if (c.category && !c.categories) {
                let newCats = [];
                const oldCategory = c.category;
                if (['Gwiazda', 'Weteran', 'Legenda'].includes(oldCategory)) {
                    newCats.push('Legend');
                }
                if (['Aktywny Zawodnik', 'Lokalny'].includes(oldCategory)) {
                    newCats.push('Polish Cup');
                }
                c.categories = [...new Set(newCats)];
                delete c.category;
            }
        });

        competitorProfiles = {};
        allDbCompetitors.forEach(c => competitorProfiles[c.name] = c);

        const container = document.getElementById('competitorSelectionList');
        if (allDbCompetitors.length === 0) {
            container.innerHTML = `<p style="text-align:center; padding: 20px;">Baza danych jest pusta. Dodaj zawodników, aby rozpocząć.</p>`;
            return;
        }
        container.innerHTML = allDbCompetitors.map(c => {
            const categoriesStr = (c.categories && c.categories.length) ? c.categories.join(',') : '';
            return `
            <label class="competitor-select-item" data-categories="${categoriesStr}">
              <input type="checkbox" value="${c.name}">
              <img src="${c.photo || 'https://placehold.co/40x40/eee/333?text=?'}" class="competitor-photo-thumb">
              <span>${c.name}</span>
            </label>
        `}).join('');

        container.addEventListener('change', updateSelectionCounter);
        filterCompetitorSelectionList('all');
        updateSelectionCounter();
    }

    function filterCompetitorSelectionList(filter) {
        document.querySelectorAll('#competitorSelectionList .competitor-select-item').forEach(item => {
            const itemCategories = item.dataset.categories ? item.dataset.categories.split(',') : [];
            if (filter === 'all' || itemCategories.includes(filter)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function updateSelectionCounter() {
        const count = document.querySelectorAll('#competitorSelectionList input:checked').length;
        document.getElementById('selectionCounter').textContent = `Wybrano: ${count}`;
    }

    document.getElementById('competitorForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('competitorId').value;
        const name = document.getElementById('competitorName').value.trim();
        const photoFile = document.getElementById('competitorPhoto').files[0];

        if (!name) {
            showNotification("Imię i nazwisko są wymagane.", "error");
            return;
        }

        const categories = Array.from(document.querySelectorAll('#competitorCategories input:checked')).map(cb => cb.value);

        const competitorData = {
            name,
            birthDate: document.getElementById('birthDate').value,
            residence: document.getElementById('residence').value.trim(),
            height: document.getElementById('height').value,
            weight: document.getElementById('weight').value,
            notes: document.getElementById('competitorNotes').value.trim(),
            categories: categories,
        };

        let photoData = null;
        if (photoFile) {
            photoData = await toBase64(photoFile);
        }

        if (id) {
            const existing = allDbCompetitors.find(c => c.id === parseInt(id));
            competitorData.id = parseInt(id);
            competitorData.photo = photoData || (existing ? existing.photo : null);
            await updateCompetitorInDb(competitorData);
            showNotification("Zawodnik zaktualizowany!", "success");
        } else {
             const existingCompetitor = allDbCompetitors.find(c => c.name.toLowerCase() === name.toLowerCase());

            if (existingCompetitor) {
                const confirmed = await showConfirmation(`Zawodnik "${name}" już istnieje. Czy chcesz nadpisać jego dane?`);
                if (confirmed) {
                    competitorData.id = existingCompetitor.id;
                    competitorData.photo = photoData || existingCompetitor.photo;
                    await updateCompetitorInDb(competitorData);
                    showNotification(`Dane dla "${name}" zostały nadpisane!`, "success");
                } else {
                    showNotification("Operacja anulowana.", "info");
                    return;
                }
            } else {
                try {
                    competitorData.photo = photoData;
                    await addCompetitorToDb(competitorData);
                    showNotification("Nowy zawodnik dodany!", "success");
                } catch (error) {
                    console.error("Error adding competitor:", error);
                    showNotification("Wystąpił nieoczekiwany błąd podczas dodawania zawodnika.", "error");
                    return;
                }
            }
        }

        closeDbPanel();
        await renderDbCompetitorList();
        await populateFullCompetitorList();
    });

    async function editCompetitor(id) {
        openDbPanel();
        const competitor = allDbCompetitors.find(c => c.id === id);
        if (!competitor) return;
        document.getElementById('competitorId').value = competitor.id;
        document.getElementById('competitorName').value = competitor.name;
        document.getElementById('birthDate').value = competitor.birthDate || '';
        document.getElementById('residence').value = competitor.residence || '';
        document.getElementById('height').value = competitor.height || '';
        document.getElementById('weight').value = competitor.weight || '';
        document.getElementById('competitorNotes').value = competitor.notes || '';

        document.querySelectorAll('#competitorCategories input').forEach(cb => cb.checked = false);
        if (competitor.categories && Array.isArray(competitor.categories)) {
            competitor.categories.forEach(cat => {
                const cb = document.querySelector(`#competitorCategories input[value="${cat}"]`);
                if (cb) cb.checked = true;
            });
        }

        document.getElementById('competitorFormBtn').textContent = 'Zapisz Zmiany';
    }

    async function confirmDeleteCompetitor(id) {
        if (await showConfirmation("Czy na pewno chcesz usunąć tego zawodnika z bazy danych? Ta operacja jest nieodwracalna.")) {
            await deleteCompetitorFromDb(id);
            showNotification("Zawodnik został usunięty.", "success");
            await renderDbCompetitorList();
            await populateFullCompetitorList();
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    function showCompetitorDetails(name) {
        const profile = competitorProfiles[name];
        if (!profile) return;
        document.getElementById('competitorDetailName').textContent = name;
        document.getElementById('competitorDetailPhoto').src = profile.photo || 'https://placehold.co/150x150/eee/333?text=?';
        const metaContainer = document.getElementById('competitorDetailMeta');
        const categoriesText = (profile.categories && profile.categories.length > 0) ? profile.categories.join(', ') : 'Brak';

        metaContainer.innerHTML = `
            <p><strong>Kategorie:</strong> ${categoriesText}</p>
            <p><strong>Zamieszkanie:</strong> ${profile.residence || 'Brak danych'}</p>
            <p><strong>Wzrost:</strong> ${profile.height ? profile.height + ' cm' : 'Brak danych'}</p>
            <p><strong>Waga:</strong> ${profile.weight ? profile.weight + ' kg' : 'Brak danych'}</p>
        `;
        document.getElementById('competitorDetailNotes').textContent = profile.notes || 'Brak dodatkowych informacji.';
        document.getElementById('competitorDetailModal').classList.add('visible');
    }

    // --- UI & NOTIFICATIONS ---
    function showNotification(message, type = 'success', duration = 3000) {
        const bar = document.getElementById('notification-bar');
        const icons = { success: '✅', error: '❌', info: 'ℹ️' };
        bar.innerHTML = `${icons[type] || ''} ${message}`;
        bar.className = type;
        bar.classList.add('show');
        setTimeout(() => bar.classList.remove('show'), duration);
    }

    function showConfirmation(message) {
      return new Promise((resolve) => {
          const modal = document.getElementById('confirmationModal');
          modal.querySelector('#modalText').textContent = message;
          modal.classList.add('visible');
          const confirmBtn = modal.querySelector('#confirmBtn');
          const cancelBtn = modal.querySelector('#cancelBtn');
          const close = (value) => { modal.classList.remove('visible'); confirmBtn.onclick = null; cancelBtn.onclick = null; resolve(value); };
          confirmBtn.onclick = () => close(true);
          cancelBtn.onclick = () => close(false);
      });
    }

    function showPrompt(message, defaultValue = '') {
        return new Promise((resolve) => {
            const modal = document.getElementById('promptModal');
            modal.querySelector('#promptText').textContent = message;
            modal.classList.add('visible');
            const input = modal.querySelector('#promptInput');
            input.value = defaultValue;
            input.focus();
            input.select();
            const confirmBtn = modal.querySelector('#promptConfirmBtn');
            const cancelBtn = modal.querySelector('#promptCancelBtn');
            const close = (value) => { modal.classList.remove('visible'); confirmBtn.onclick = null; cancelBtn.onclick = null; input.onkeydown = null; resolve(value); };
            confirmBtn.onclick = () => close(input.value);
            cancelBtn.onclick = () => close(null);
            input.onkeydown = (e) => { if (e.key === 'Enter') close(input.value); };
        });
    }

    // --- STATE MANAGEMENT ---
    function getCurrentState(includeResults = true) {
      const state = {
        competitors: JSON.parse(JSON.stringify(competitors)),
        scores: JSON.parse(JSON.stringify(scores)),
        eventNumber,
        eventHistory: JSON.parse(JSON.stringify(eventHistory)),
        logoData,
        currentEventType,
        eventTitle: document.getElementById('eventTitle')?.textContent || `Konkurencja ${eventNumber}`,
        eventName: document.getElementById('eventNameInput').value,
        eventLocation: document.getElementById('eventLocationInput').value,
        stopwatchCheckpointCounter
      };
      if (includeResults && document.getElementById('mainContent').style.display === 'block') {
        state.currentResults = {};
        document.querySelectorAll('.resultInput').forEach(input => {
            if(!input.readOnly) state.currentResults[input.dataset.name] = input.value;
        });
      }
      return state;
    }

    function saveToUndoHistory() {
      undoHistory.push(getCurrentState());
      redoHistory = [];
      document.getElementById('undoBtn').disabled = false;
      document.getElementById('redoBtn').disabled = true;
    }

    function restoreState(state, fromFileOrCheckpoint = false) {
      if (!state || !state.competitors) {
        showNotification("Nieprawidłowe dane do wczytania stanu.", "error");
        return;
      }
      competitors = state.competitors;
      scores = state.scores;
      eventNumber = state.eventNumber;
      eventHistory = state.eventHistory;
      logoData = state.logoData;
      currentEventType = state.currentEventType;
      stopwatchCheckpointCounter = state.stopwatchCheckpointCounter || 1;

      document.getElementById('intro').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';

      document.getElementById('eventTitle').textContent = state.eventTitle || `Konkurencja ${eventNumber}`;
      document.getElementById('eventNameInput').value = state.eventName || '';
      document.getElementById('eventLocationInput').value = state.eventLocation || '';

      if(logoData) {
        document.getElementById('logoImg').src = logoData;
        document.getElementById('selectLogoBtn').style.display = 'none';
      } else {
        removeLogo();
      }
      setEventType(currentEventType, false);
      renderTable();

      if(state.currentResults){
          Object.keys(state.currentResults).forEach(name => {
              const input = document.querySelector(`.resultInput[data-name="${CSS.escape(name)}"]`);
              if (input) input.value = state.currentResults[name];
          });
      }
       if (eventHistory.length > 0 && eventHistory[eventHistory.length-1].nr === eventNumber) {
           renderTableWithCurrentEventData(eventHistory[eventHistory.length-1].results);
             document.querySelectorAll('.resultInput').forEach(input => input.readOnly = true);
       }

      if(fromFileOrCheckpoint) {
        recalculateAllPoints();
        recalculateTotalScores();
        renderTable();
        showNotification("Stan aplikacji został pomyślnie wczytany!", "success");
      }
    }

    function undoLastAction() {
      if (undoHistory.length === 0) return;
      redoHistory.push(getCurrentState());
      restoreState(undoHistory.pop());
      triggerAutoSave();
      document.getElementById('redoBtn').disabled = false;
      if (undoHistory.length === 0) document.getElementById('undoBtn').disabled = true;
    }

    function redoLastAction() {
        if (redoHistory.length === 0) return;
        undoHistory.push(getCurrentState());
        restoreState(redoHistory.pop());
        triggerAutoSave();
        document.getElementById('undoBtn').disabled = false;
        if (redoHistory.length === 0) document.getElementById('redoBtn').disabled = true;
    }

    // --- SAVE/LOAD & BACKUP SYSTEM ---

    function saveState(key, data) {
      try {
        const stateToSave = data || getCurrentState();
        localStorage.setItem(key, JSON.stringify(stateToSave));
      }
      catch (e) {
        console.error("Save state error:", e);
        showNotification("Błąd zapisu stanu. Pamięć przeglądarki może być pełna.", "error", 5000);
      }
    }

    async function loadState(key) {
      const savedStateJSON = localStorage.getItem(key);
      if (!savedStateJSON) {
        return false;
      }

      const promptMessage = "Czy chcesz przywrócić stan z ostatniej sesji? Spowoduje to utratę wszelkich niezapisanych zmian.";

      if (await showConfirmation(promptMessage)) {
        try {
          await populateFullCompetitorList();
          restoreState(JSON.parse(savedStateJSON), true);
          undoHistory = []; redoHistory = [];
          document.getElementById('undoBtn').disabled = true;
          document.getElementById('redoBtn').disabled = true;
          showNotification(`Wczytano ostatnią sesję!`, "success");
          return true;
        } catch (error) {
          console.error("Load state error:", error);
          showNotification("Błąd wczytywania zapisu. Plik może być uszkodzony.", "error");
          localStorage.removeItem(key);
          return false;
        }
      } else {
        localStorage.removeItem('strongmanState_autoSave');
        return false;
      }
    }

    function triggerAutoSave() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            if(document.getElementById('mainContent').style.display === 'block') {
                saveState('strongmanState_autoSave');
                const indicator = document.getElementById('saveIndicator');
                indicator.classList.add('visible');
                setTimeout(() => indicator.classList.remove('visible'), 1500);
            }
        }, 2000);
    }

    async function saveCheckpoint(nameOverride = null) {
        let name;
        if(nameOverride) {
            name = nameOverride;
        } else {
            const defaultName = `Konkurencja ${eventNumber}: ${document.getElementById('eventTitle').textContent}`;
            name = await showPrompt("Wprowadź nazwę dla punktu kontrolnego:", defaultName);
        }

        if (name && name.trim()) {
            const timestamp = Date.now();
            const newCheckpoint = {
                name: name.trim(),
                timestamp: timestamp,
                state: getCurrentState()
            };
            try {
                localStorage.setItem(`${CHECKPOINT_PREFIX}${timestamp}`, JSON.stringify(newCheckpoint));
                showNotification(`Punkt kontrolny "${name.trim()}" został zapisany!`, 'success');
            } catch (e) {
                console.error("Error saving checkpoint:", e);
                showNotification("Błąd zapisu punktu kontrolnego. Pamięć przeglądarki może być pełna.", "error", 5000);
            }
            document.getElementById('checkpointListContainer').style.display = 'none';
        }
    }

    function showCheckpoints() {
        const container = document.getElementById('checkpointListContainer');
        const list = document.getElementById('checkpointList');

        const checkpoints = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(CHECKPOINT_PREFIX)) {
                try {
                    checkpoints.push(JSON.parse(localStorage.getItem(key)));
                } catch(e) {
                    console.error(`Could not parse checkpoint with key ${key}`, e);
                }
            }
        }

        container.style.display = 'block';
        if (checkpoints.length === 0) {
            list.innerHTML = '<p>Brak zapisanych punktów kontrolnych.</p>';
            return;
        }

        checkpoints.sort((a, b) => b.timestamp - a.timestamp);

        list.innerHTML = '';
        checkpoints.forEach(cp => {
            const btn = document.createElement('button');
            const date = new Date(cp.timestamp).toLocaleString('pl-PL');
            btn.innerHTML = `<b>${cp.name}</b><br><small>${date}</small>`;
            btn.onclick = () => loadCheckpoint(cp.timestamp);
            list.appendChild(btn);
        });
    }

    async function loadCheckpoint(timestamp) {
        const key = `${CHECKPOINT_PREFIX}${timestamp}`;
        const checkpointJSON = localStorage.getItem(key);

        if (checkpointJSON) {
            const checkpoint = JSON.parse(checkpointJSON);
            if (await showConfirmation(`Czy chcesz wczytać punkt kontrolny "${checkpoint.name}"? Spowoduje to nadpisanie wszelkich niezapisanych zmian.`)) {
                try {
                    await populateFullCompetitorList();
                    restoreState(checkpoint.state, true);
                    undoHistory = [];
                    redoHistory = [];
                    document.getElementById('undoBtn').disabled = true;
                    document.getElementById('redoBtn').disabled = true;
                } catch (error) {
                    console.error("Load checkpoint error:", error);
                    showNotification("Błąd wczytywania punktu kontrolnego.", "error");
                }
            }
        } else {
            showNotification("Wybrany punkt kontrolny nie został znaleziony.", "error");
        }
    }

    function exportStateToFile() {
        const state = getCurrentState();
        const stateJson = JSON.stringify(state, null, 2);
        const blob = new Blob([stateJson], { type: 'application/json' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        const eventName = document.getElementById('eventNameInput').value.replace(/ /g, '_') || 'zawody';
        link.download = `strongman_stan_backup_${eventName}_${new Date().toISOString().slice(0,10)}.json`;
        link.click();
        URL.revokeObjectURL(link.href);
    }

    function importStateFromFile() {
      if (document.getElementById('mainContent').style.display === 'block') {
        document.getElementById('importFile2').click();
      } else {
        document.getElementById('importFile').click();
      }
    }

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedData = JSON.parse(e.target.result);

                if (Array.isArray(importedData)) {
                    showNotification("Błąd: To jest plik bazy danych zawodników. Użyj opcji 'Importuj Bazę'.", "error", 8000);
                    return;
                }

                if (typeof importedData !== 'object' || importedData === null || !('competitors' in importedData) || !('eventHistory' in importedData)) {
                    throw new Error("Plik nie zawiera prawidłowych danych stanu aplikacji.");
                }

                const state = importedData;

                if (await showConfirmation("Czy na pewno chcesz importować stan z tego pliku? Spowoduje to nadpisanie obecnego stanu.")) {
                    await populateFullCompetitorList();
                    restoreState(state, true);
                }
            } catch (error) {
                console.error("State import error:", error);
                showNotification("Błąd: Nieprawidłowy format pliku stanu aplikacji.", "error");
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    async function exportCompetitorDb() {
        try {
            const allCompetitors = await getCompetitorsFromDb();
            const exportData = allCompetitors.map(({ id, ...rest }) => rest);

            const dbJson = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dbJson], { type: 'application/json' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `strongman_baza_zawodnikow_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
            showNotification("Baza danych zawodników została pomyślnie wyeksportowana!", "success");
        } catch (error) {
            console.error("Database export error:", error);
            showNotification("Wystąpił błąd podczas eksportowania bazy danych.", "error");
        }
    }

    function handleDbFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedData = JSON.parse(e.target.result);

                if (!Array.isArray(importedData)) {
                    if (typeof importedData === 'object' && importedData !== null && 'competitors' in importedData && 'eventHistory' in importedData) {
                         showNotification("Błąd: To jest plik stanu aplikacji. Użyj opcji 'Importuj Stan z Pliku'.", "error", 8000);
                    } else {
                        throw new Error("Plik nie zawiera prawidłowej listy zawodników.");
                    }
                    return;
                }

                const importedCompetitors = importedData;

                if (await showConfirmation(`Czy na pewno chcesz importować bazę danych z tego pliku? Spowoduje to dodanie nowych zawodników i zaktualizowanie istniejących (na podstawie imienia i nazwiska).`)) {
                    let updatedCount = 0;
                    let addedCount = 0;

                    const currentDbCompetitors = await getCompetitorsFromDb();
                    const currentNames = new Map(currentDbCompetitors.map(c => [c.name.toLowerCase(), c]));

                    for (const importedComp of importedCompetitors) {
                        if (!importedComp.name) continue;

                        const existingComp = currentNames.get(importedComp.name.toLowerCase());

                        if (existingComp) {
                            const dataToUpdate = { ...existingComp, ...importedComp };
                            await updateCompetitorInDb(dataToUpdate);
                            updatedCount++;
                        } else {
                            await addCompetitorToDb(importedComp);
                            addedCount++;
                        }
                    }

                    showNotification(`Import zakończony! Zaktualizowano: ${updatedCount}, Dodano: ${addedCount}.`, "success", 5000);
                    await renderDbCompetitorList();
                    await populateFullCompetitorList();
                }
            } catch (error) {
                console.error("Database import error:", error);
                showNotification("Błąd: Nieprawidłowy format pliku bazy danych.", "error");
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }


    // --- CORE COMPETITION LOGIC ---

    function parseResult(rawValue, eventType) {
        const valStr = String(rawValue).trim().replace(',', '.').toLowerCase();
        const worstVal = eventType === 'high' ? -Infinity : +Infinity;

        if (valStr === "0") {
            return { val: worstVal, raw: rawValue, zero: true };
        }

        if (valStr === "") {
            return { val: worstVal, raw: rawValue, zero: true };
        }

        if (eventType === 'low') {
            if (valStr.startsWith('0') && valStr !== "0") {
                const distance = parseFloat(valStr);
                if (isNaN(distance)) {
                    return { val: worstVal, raw: rawValue, zero: true };
                }
                return { val: 10000 - distance, raw: rawValue, zero: false };
            }

            const time = parseFloat(valStr);
            if (isNaN(time)) {
                return { val: worstVal, raw: rawValue, zero: true };
            }
            return { val: time, raw: rawValue, zero: false };
        }

        if (eventType === 'high') {
            const score = parseFloat(valStr);
            if (isNaN(score)) {
                return { val: worstVal, raw: rawValue, zero: true };
            }
            return { val: score, raw: rawValue, zero: false };
        }
    }

    function showEditableResults(eventNr) {
      const eventToEdit = eventHistory.find(e => e.nr === eventNr);
      if (!eventToEdit) return;
      const details = document.getElementById("eventDetails");
      let html = `<h4>Edycja: ${eventToEdit.name}</h4><table id="editTable_${eventNr}"><tr><th>Zawodnik</th><th>Wynik</th></tr>`;
      eventToEdit.results.forEach(w => {
        html += `<tr><td>${w.name}</td><td><input class="editable-result" data-name="${w.name}" value="${w.result}" type="text" inputmode="text"></td></tr>`;
      });
      html += `</table><button onclick="saveAndRecalculate(${eventNr})">Zapisz i Przelicz Ponownie</button>`;
      details.innerHTML = html;
    }

    function saveAndRecalculate(eventNr) {
        saveToUndoHistory();
        const eventToUpdate = eventHistory.find(e => e.nr === eventNr);
        if (!eventToUpdate) return;

        const editedInputs = document.querySelectorAll(`#editTable_${eventNr} .editable-result`);
        editedInputs.forEach(input => {
            const resultToUpdate = eventToUpdate.results.find(w => w.name === input.dataset.name);
            if(resultToUpdate) {
                resultToUpdate.result = input.value;
            }
        });

        recalculateAllPoints();
        recalculateTotalScores();

        renderTable();
        showResults();
        document.getElementById("eventDetails").innerHTML = '<p style="text-align:center; color:green;">Wyniki zostały przeliczone!</p>';
        triggerAutoSave();
        showNotification('Wyniki zostały pomyślnie przeliczone!', 'success');
    }

    function recalculateAllPoints() {
        eventHistory.forEach(event => {
            const results = event.results.map(w => {
                const parsed = parseResult(w.result, event.type);
                parsed.name = w.name;
                return parsed;
            });

            results.sort((a, b) => event.type === 'high' ? b.val - a.val : a.val - b.val);

            const total = competitors.length;
            for (let i = 0; i < results.length; ) {
              let j = i;
              while (j < results.length && results[j].val === results[i].val) j++;
              const tiedCount = j - i;
              let sumPts = 0;
              for (let k = i; k < j; k++) {
                if (!results[k].zero) {
                    sumPts += (total - k);
                }
              }
              const avgPts = tiedCount > 0 ? sumPts / tiedCount : 0;
              for (let k = i; k < j; k++) {
                const resultToUpdate = event.results.find(w => w.name === results[k].name);
                resultToUpdate.points = (results[k].zero ? 0 : avgPts).toFixed(2);
                resultToUpdate.place = results[k].zero ? "-" : (i + 1);
              }
              i = j;
            }
        });
    }

    function recalculateTotalScores() {
        Object.keys(scores).forEach(name => scores[name] = 0);
        eventHistory.forEach(event => {
            event.results.forEach(result => {
                if (scores[result.name] !== undefined) {
                    scores[result.name] += parseFloat(result.points);
                }
            });
        });
    }

    function setEventType(type, recordUndo = true) {
      if(recordUndo && currentEventType !== type) saveToUndoHistory();
      currentEventType = type;
      document.getElementById('highTypeBtn').classList.toggle('active', type === 'high');
      document.getElementById('lowTypeBtn').classList.toggle('active', type === 'low');
      triggerAutoSave();
    }

    function startCompetition() {
      const selectedInputs = document.querySelectorAll('#competitorSelectionList input:checked');
      competitors = Array.from(selectedInputs).map(input => input.value);

      if (competitors.length < 2) { showNotification("Wybierz co najmniej dwóch zawodników.", "error"); return; }
      scores = {};
      competitors.forEach(name => { scores[name] = 0; });
      eventNumber = 1; eventHistory = []; undoHistory = []; redoHistory = [];
      document.getElementById('undoBtn').disabled = true;
      document.getElementById('redoBtn').disabled = true;
      document.getElementById("intro").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      renderTable();
      triggerAutoSave();
    }

    function renderTable() {
      const tbody = document.querySelector("#resultsTable tbody");
      tbody.innerHTML = competitors.map(name => {
        const profile = competitorProfiles[name] || {};
        return `
        <tr data-name="${name}">
          <td>
            <div class="competitor-cell">
              <img src="${profile.photo || 'https://placehold.co/40x40/eee/333?text=?'}" class="competitor-photo-thumb" alt="${name}" onclick="enterFullscreenStopwatch('${name}')" title="Uruchom stoper dla ${name}">
              <span>${name}</span>
              <span class="info-icon" onclick="showCompetitorDetails('${name}')" aria-label="Pokaż szczegóły zawodnika">ℹ️</span>
            </div>
          </td>
          <td class="result-cell">
            <input class="resultInput" data-name="${name}" type="text" inputmode="text" />
          </td>
          <td data-type="place">-</td>
          <td data-type="points">0.00</td>
          <td data-type="sum">${(scores[name] || 0).toFixed(2)}</td>
        </tr>
      `}).join('');

      document.querySelectorAll('.resultInput').forEach(input => {
        input.addEventListener('input', triggerAutoSave);
      });
    }

    function shuffleCompetitors() {
      saveToUndoHistory();
      for (let i = competitors.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [competitors[i], competitors[j]] = [competitors[j], competitors[i]];
      }
      renderTable();
      triggerAutoSave();
    }

    function calculatePoints() {
      saveToUndoHistory();
      try {
        const inputs = [...document.querySelectorAll('.resultInput')];
        const eventName = document.getElementById('eventTitle').textContent;
        let hasError = false;

        const results = inputs.map(input => {
            const parsed = parseResult(input.value, currentEventType);
            parsed.name = input.dataset.name;
            if(parsed.zero && parsed.raw !== "" && parsed.raw !== "0") {
                input.style.borderColor = 'red';
                hasError = true;
            } else {
                input.style.borderColor = '';
            }
            return parsed;
        });

        if (hasError) { throw new Error("Nieprawidłowa liczba lub format"); }

        results.sort((a, b) => currentEventType === 'high' ? b.val - a.val : a.val - b.val);

        let eventResults = [];
        const total = competitors.length;

        for (let i = 0; i < results.length; ) {
          let j = i;
          while (j < results.length && results[j].val === results[i].val) j++;
          const tiedCount = j - i;
          let sumPts = 0;
          for (let k = i; k < j; k++) {
            if (!results[k].zero) sumPts += (total - k);
          }
          const avgPts = tiedCount > 0 ? sumPts / tiedCount : 0;
          for (let k = i; k < j; k++) {
            eventResults.push({ name: results[k].name, result: results[k].raw, place: results[k].zero ? "-" : (i + 1), points: (results[k].zero ? 0 : avgPts).toFixed(2) });
          }
          i = j;
        }

        eventHistory.push({ nr: eventNumber, name: eventName, type: currentEventType, results: eventResults });
        recalculateTotalScores();
        renderTableWithCurrentEventData(eventResults);
        inputs.forEach(input => input.readOnly = true);
        document.querySelectorAll('td[data-type="points"], td[data-type="sum"]').forEach(cell => {
            cell.classList.add('highlight-flash');
            cell.addEventListener('animationend', () => cell.classList.remove('highlight-flash'), { once: true });
        });
        triggerAutoSave();
      } catch (error) {
        showNotification("Proszę wpisać prawidłowe wartości. Niepoprawne pola są zaznaczone na czerwono.", "error", 4000);
      }
    }

    function renderTableWithCurrentEventData(eventResults) {
        eventResults.forEach(res => {
            const row = document.querySelector(`#resultsTable tr[data-name="${CSS.escape(res.name)}"]`);
            if(row) {
                row.querySelector('.resultInput').value = res.result;
                row.querySelector('td[data-type="place"]').textContent = res.place;
                row.querySelector('td[data-type="points"]').textContent = res.points;
                row.querySelector('td[data-type="sum"]').textContent = (scores[res.name] || 0).toFixed(2);
            }
        });
    }

    async function nextEvent() {
      if (document.querySelectorAll('.resultInput:not([readonly])').length === 0) {
        const confirmed = await showConfirmation("Pamiętaj, aby ustawić prawidłowy tryb konkurencji (Więcej = Lepiej / Mniej = Lepiej). Czy chcesz kontynuować?");
        if (!confirmed) {
            showNotification("Zmiana konkurencji anulowana. Ustaw tryb i spróbuj ponownie.", "info");
            return;
        }
      } else {
         const confirmed = await showConfirmation("Nie przyznano punktów w obecnej konkurencji. Czy na pewno chcesz kontynuować? Wyniki nie zostaną zapisane.");
         if (!confirmed) return;
      }
      
      saveToUndoHistory();
      eventNumber++;
      const lastEvent = eventHistory[eventHistory.length-1];
      const lastScores = {};
      if (lastEvent) { lastEvent.results.forEach(res => { lastScores[res.name] = parseFloat(res.points); }); }
      competitors.sort((a, b) => (lastScores[a] || 0) - (lastScores[b] || 0));
      document.getElementById('eventTitle').textContent = "Konkurencja " + eventNumber;
      renderTable();
      triggerAutoSave();
    }

    function finalEvent() {
      saveToUndoHistory();
      competitors.sort((a, b) => ((scores[b] || 0) - (scores[a] || 0)) || breakTie(a, b).outcome).reverse();
      document.getElementById('eventTitle').textContent = "Konkurencja Finałowa";
      renderTable();
      triggerAutoSave();
    }

    async function resetCompetition() {
        if (await showConfirmation("Czy na pewno chcesz zresetować zawody? Spowoduje to usunięcie wszystkich danych (z wyjątkiem bazy danych zawodników).")) {
            localStorage.removeItem('strongmanState_autoSave');
            localStorage.removeItem('isTableExpanded');

            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key.startsWith(CHECKPOINT_PREFIX)) {
                    localStorage.removeItem(key);
                }
            }

            competitors = [];
            scores = {};
            eventNumber = 1;
            eventHistory = [];
            currentEventType = 'high';
            undoHistory = [];
            redoHistory = [];
            stopwatchCheckpointCounter = 1;

            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('intro').style.display = 'block';
            document.getElementById('finalSummaryPanel')?.remove();

            await populateFullCompetitorList();

            showNotification("Aplikacja została zresetowana.", "success");
        }
    }

    function showResults() {
      const panel = document.getElementById("historyPanel");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
      const list = document.getElementById("eventList");
      list.innerHTML = "";
      eventHistory.forEach(event => {
        const btn = document.createElement("button");
        btn.textContent = `Edytuj Konkurencję ${event.nr}: ${event.name}`;
        btn.onclick = () => showEditableResults(event.nr);
        list.appendChild(btn);
      });
      if(eventHistory.length > 0) document.getElementById("eventDetails").innerHTML = '<p style="text-align:center;">Wybierz konkurencję do edycji.</p>';
    }

    function breakTie(a, b) {
      const countPlaces = (name) => {
        const places = Array(competitors.length + 1).fill(0);
        eventHistory.forEach(e => {
          const result = e.results.find(w => w.name === name);
          if (result && result.place !== "-") {
            const place = parseInt(result.place);
            if (!isNaN(place)) places[place]++;
          }
        });
        return places;
      };

      const aPlaces = countPlaces(a), bPlaces = countPlaces(b);
      for (let i = 1; i <= competitors.length; i++) {
        if (aPlaces[i] !== bPlaces[i]) {
            return { outcome: bPlaces[i] - aPlaces[i], reason: `więcej ${i}. miejsc` };
        }
      }

      const lastEvent = eventHistory[eventHistory.length - 1];
      if (lastEvent) {
        const aResult = lastEvent.results.find(r => r.name === a);
        const bResult = lastEvent.results.find(r => r.name === b);
        if (aResult && bResult && aResult.points !== bResult.points) {
          return { outcome: parseFloat(bResult.points) - parseFloat(aResult.points), reason: `lepszy wynik w ostatniej konkurencji` };
        }
      }

      return { outcome: 0, reason: "Remis nierozstrzygnięty" };
    }

    function showFinalSummary() {
        const existingPanel = document.getElementById('finalSummaryPanel');
        if (existingPanel) existingPanel.remove();

        const panel = document.createElement('div');
        panel.className = 'panel';
        panel.id = 'finalSummaryPanel';
        document.getElementById('mainContent').appendChild(panel);

        const finalStandings = [...competitors].sort((a, b) => {
            const scoreDiff = (scores[b] || 0) - (scores[a] || 0);
            if (scoreDiff !== 0) return scoreDiff;
            return breakTie(a, b).outcome;
        });

        let standingsData = finalStandings.map(name => ({
            name: name,
            score: (scores[name] || 0).toFixed(2),
            tieInfo: ''
        }));

        for (let i = 0; i < standingsData.length - 1; i++) {
            if (standingsData[i].score === standingsData[i+1].score) {
                 const tieResult = breakTie(standingsData[i].name, standingsData[i+1].name);
                 if(tieResult.reason !== "Remis nierozstrzygnięty") {
                     standingsData[i].tieInfo = `<span class="tie-info" title="${tieResult.reason}">(i)<span class="tooltip">Wygrana przez: ${tieResult.reason}</span></span>`;
                 }
            }
        }

        let html = `<h3>Klasyfikacja Końcowa</h3><div class="table-wrapper"><table><thead><tr><th>Miejsce</th><th>Zawodnik</th><th>Suma</th></tr></thead><tbody>`;

        standingsData.forEach((data, i) => {
            const currentPlace = i + 1;
            const medalClass = currentPlace === 1 ? "gold" : currentPlace === 2 ? "silver" : currentPlace === 3 ? "bronze" : "";
            const profile = competitorProfiles[data.name] || {};

            html += `<tr class="${medalClass}">
                <td>${currentPlace}</td>
                <td>
                    <div class="competitor-cell">
                        <img src="${profile.photo || 'https://placehold.co/40x40/eee/333?text=?'}" class="competitor-photo-thumb" alt="${data.name}">
                        <span>${data.name} ${data.tieInfo}</span>
                    </div>
                </td>
                <td>${data.score}</td>
            </tr>`;
        });

        panel.innerHTML = html + `</tbody></table></div>`;
        panel.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    function handleLogoUpload(event) {
        const file = event.target.files[0]; if (!file) return;
        toBase64(file).then(data => {
            logoData = data;
            document.getElementById('logoImg').src = logoData;
            localStorage.setItem('strongmanLogo', logoData);
            document.getElementById('selectLogoBtn').style.display = 'none';
            triggerAutoSave();
        });
    }

    function removeLogo() {
        logoData = null;
        document.getElementById('logoImg').src = "";
        localStorage.removeItem('strongmanLogo');
        document.getElementById('selectLogoBtn').style.display = '';
        triggerAutoSave();
    }

    function generateExportHTML(title, bodyContent) {
        const eventName = document.getElementById('eventNameInput').value || 'Zawody Strongman';
        const eventLocation = document.getElementById('eventLocationInput').value || '';
        let html = `<!DOCTYPE html><html lang="pl"><head><meta charset="utf-8"><title>${title} - ${eventName}</title><style>body{font-family:Arial,sans-serif;max-width:900px;margin:auto;padding:20px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:8px;text-align:left;border-bottom:1px solid #ddd;vertical-align:middle}th{background-color:#f5f5f5}.export-logo{max-height:80px;display:block;margin:0 auto 20px}.event-meta{text-align:center;margin-bottom:20px}h1,h2{color:#2c3e50}.gold{background-color:#fff9c4}.silver{background-color:#f5f5f5}.bronze{background-color:#ffecb3}.competitor-cell{display:flex;align-items:center;gap:10px}.competitor-photo-thumb{width:30px;height:30px;border-radius:50%;object-fit:cover}</style></head><body>`;
        if (logoData) html += `<img src="${logoData}" class="export-logo">`;
        html += `<div class="event-meta"><h1>${eventName}</h1>${eventLocation ? `<p>${eventLocation}</p>` : ''}<p>${new Date().toLocaleString('pl-PL')}</p></div>${bodyContent}</body></html>`;
        return html;
    }

    function exportResultsHTML() {
        const summaryPanel = document.getElementById('finalSummaryPanel');
        if (!summaryPanel) {
            showFinalSummary();
        }
        const panelToPrint = document.getElementById('finalSummaryPanel');
        const body = panelToPrint.innerHTML;

        const blob = new Blob([generateExportHTML('Wyniki Końcowe', body)], { type: 'text/html' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = 'strongman_wyniki.html';
        link.click();
        URL.revokeObjectURL(link.href);
    }

    async function exportToPDF() {
        showNotification("Generowanie PDF... To może chwilę potrwać.", "info", 5000);

        const printContainer = document.createElement('div');
        printContainer.id = 'pdfPrintContainer';
        printContainer.style.position = 'absolute';
        printContainer.style.left = '-9999px';
        printContainer.style.width = '800px';
        printContainer.style.background = 'white';
        printContainer.style.color = '#333';
        document.body.appendChild(printContainer);

        printContainer.innerHTML = `
            <style>
                #pdfPrintContainer { font-family: Arial, sans-serif; padding: 20px; box-sizing: border-box; }
                #pdfPrintContainer h1, #pdfPrintContainer h2, #pdfPrintContainer h3, #pdfPrintContainer h4 { color: #2c3e50; text-align: center; margin-bottom: 10px; margin-top: 15px; }
                #pdfPrintContainer table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 15px; }
                #pdfPrintContainer .pdf-block { margin-bottom: 20px; }
                #pdfPrintContainer th, #pdfPrintContainer td { padding: 8px; text-align: left; border: 1px solid #ddd; word-wrap: break-word; }
                #pdfPrintContainer th { background-color: #f2f2f2; font-weight: bold; }
                #pdfPrintContainer .gold { background-color:#fff9c4 !important; }
                #pdfPrintContainer .silver { background-color:#f5f5f5 !important; }
                #pdfPrintContainer .bronze { background-color:#ffecb3 !important; }
                #pdfPrintContainer .competitor-cell { display: flex; align-items: center; gap: 10px; }
                #pdfPrintContainer .competitor-photo-thumb { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
                #pdfPrintContainer .export-logo { max-height: 80px; display: block; margin: 0 auto 20px; }
                #pdfPrintContainer .event-meta { text-align: center; margin-bottom: 20px; }
            </style>
        `;

        const metaDiv = document.createElement('div');
        metaDiv.className = 'pdf-block event-meta';
        let metaHTML = '';
        if (logoData) metaHTML += `<img src="${logoData}" class="export-logo">`;
        metaHTML += `<h1>${document.getElementById('eventNameInput').value || 'Zawody Strongman'}</h1>
                    ${document.getElementById('eventLocationInput').value ? `<p>${document.getElementById('eventLocationInput').value}</p>` : ''}
                    <p>Data: ${new Date().toLocaleString('pl-PL')}</p>`;
        metaDiv.innerHTML = metaHTML;
        printContainer.appendChild(metaDiv);

        if (!document.getElementById('finalSummaryPanel')) {
            showFinalSummary();
        }

        const summaryPanel = document.getElementById('finalSummaryPanel');
        if (summaryPanel) {
            const summaryClone = summaryPanel.cloneNode(true);
            summaryClone.classList.add('pdf-block');
            printContainer.appendChild(summaryClone);
        }

        if (eventHistory.length > 0) {
            const historyHeader = document.createElement('h2');
            historyHeader.className = 'pdf-block';
            historyHeader.textContent = 'Szczegółowe Wyniki Konkurencji';
            printContainer.appendChild(historyHeader);

            const runningScores = {};
            competitors.forEach(c => runningScores[c] = 0);

            eventHistory.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'pdf-block';
                eventDiv.innerHTML = `<h4>${event.nr}. ${event.name} (${event.type === 'high' ? 'Więcej = Lepiej' : 'Mniej = Lepiej'})</h4>`;
                let tableHTML = '<table><thead><tr><th>Miejsce</th><th>Zawodnik</th><th>Wynik</th><th>Pkt.</th><th>Suma Pkt.</th></tr></thead><tbody>';

                const sortedResults = [...event.results].sort((a,b) => {
                    const placeA = a.place === '-' ? Infinity : parseInt(a.place);
                    const placeB = b.place === '-' ? Infinity : parseInt(b.place);
                    return placeA - placeB;
                });

                sortedResults.forEach(res => {
                    runningScores[res.name] += parseFloat(res.points);
                    tableHTML += `<tr><td>${res.place}</td><td>${res.name}</td><td>${res.result || 'B/D'}</td><td>${res.points}</td><td>${runningScores[res.name].toFixed(2)}</td></tr>`;
                });

                tableHTML += '</tbody></table>';
                eventDiv.innerHTML += tableHTML;
                printContainer.appendChild(eventDiv);
            });
        }

        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const marginX = 15;
            const marginY = 15;
            const contentWidth = pdfWidth - (marginX * 2);
            let currentY = marginY;

            const blocks = printContainer.querySelectorAll('.pdf-block');

            for (const block of blocks) {
                const canvas = await html2canvas(block, { scale: 2, useCORS: true, allowTaint: true, windowWidth: block.scrollWidth, windowHeight: block.scrollHeight });
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * contentWidth) / imgProps.width;

                if (currentY + imgHeight > pdfHeight - marginY && currentY > marginY) {
                    pdf.addPage();
                    currentY = marginY;
                }

                pdf.addImage(imgData, 'PNG', marginX, currentY, contentWidth, imgHeight);
                currentY += imgHeight + 5;
            }

            pdf.save(`strongman_wyniki_${new Date().toISOString().slice(0,10)}.pdf`);

        } catch (err) {
            console.error("PDF generation error:", err);
            showNotification("Błąd podczas generowania PDF. Spróbuj ponownie.", "error");
        } finally {
            document.body.removeChild(printContainer);
        }
    }


    function openFocusMode(index) {
        focusModeIndex = index;
        document.getElementById('focusModeModal').classList.add('visible');
        renderFocusModeView();
    }

    function renderFocusModeView() {
        if (focusModeIndex < 0 || focusModeIndex >= competitors.length) return;
        const name = competitors[focusModeIndex];
        const profile = competitorProfiles[name] || {};
        const tableRow = document.querySelector(`#resultsTable tr[data-name="${CSS.escape(name)}"]`);
        const tableInput = tableRow ? tableRow.querySelector('.resultInput') : null;
        document.getElementById('focusCompetitorName').textContent = name;
        document.getElementById('focusCompetitorPhoto').src = profile.photo || 'https://placehold.co/120x120/eee/333?text=?';
        const focusInput = document.getElementById('focusResultInput');
        focusInput.value = tableInput ? tableInput.value : '';

        setTimeout(() => { focusInput.focus(); focusInput.select(); }, 100);

        const confirmBtn = document.getElementById('focusConfirmNextBtn');
        if (focusModeIndex === competitors.length - 1) {
            confirmBtn.textContent = 'Zatwierdź i Zakończ';
            document.getElementById('focusNextBtn').disabled = true;
        } else {
            confirmBtn.textContent = 'Zatwierdź i Następny';
            document.getElementById('focusNextBtn').disabled = false;
        }
        document.getElementById('focusPrevBtn').disabled = focusModeIndex === 0;
    }

    function saveFocusInput() {
        if (focusModeIndex < 0 || focusModeIndex >= competitors.length) return;
        const name = competitors[focusModeIndex];
        const tableRow = document.querySelector(`#resultsTable tr[data-name="${CSS.escape(name)}"]`);
        if (tableRow) {
            tableRow.querySelector('.resultInput').value = document.getElementById('focusResultInput').value;
        }
        triggerAutoSave();
    }

    function closeFocusMode() {
        saveFocusInput();
        document.getElementById('focusModeModal').classList.remove('visible');
    }

    function navigateFocusMode(direction) {
        saveFocusInput();
        const newIndex = focusModeIndex + direction;
        if (newIndex >= 0 && newIndex < competitors.length) {
            focusModeIndex = newIndex;
            renderFocusModeView();
        } else if (direction === 1 && newIndex === competitors.length) {
            closeFocusMode();
        }
    }

    async function processPastedCompetitors() {
        const currentlyChecked = [...document.querySelectorAll('#competitorSelectionList input:checked')].map(cb => cb.value.toLowerCase());
        const pastedText = document.getElementById('pastedCompetitors').value.trim();
        if (!pastedText) { showNotification('Obszar wklejania jest pusty.', 'error'); return; }

        const pastedNames = pastedText.split('\n').map(name => name.trim()).filter(name => name);
        let newCompetitorsAddedCount = 0;
        let existingCompetitorsCount = 0;

        for (const name of pastedNames) {
            const alreadyExistsInDb = allDbCompetitors.some(c => c.name.toLowerCase() === name.toLowerCase());
            if (!alreadyExistsInDb) {
                await addCompetitorToDb({ name: name, categories: ['Polish Cup'], notes: 'Dodano automatycznie z listy', photo: `https://placehold.co/150x150/eee/333?text=${name.substring(0,1)}` });
                newCompetitorsAddedCount++;
            } else {
                existingCompetitorsCount++;
            }
        }

        if (newCompetitorsAddedCount > 0) {
            showNotification(`${newCompetitorsAddedCount} nowych zawodników dodano do bazy.`, 'success');
            await populateFullCompetitorList();
        }
        if (existingCompetitorsCount > 0) {
            showNotification(`${existingCompetitorsCount} zawodników z listy było już w bazie.`, 'info');
        }

        const namesToSelect = new Set([...currentlyChecked, ...pastedNames.map(n => n.toLowerCase())]);
        document.querySelectorAll('#competitorSelectionList input[type="checkbox"]').forEach(checkbox => {
            if (namesToSelect.has(checkbox.value.toLowerCase())) checkbox.checked = true;
        });

        document.getElementById('pastedCompetitors').value = '';
        updateSelectionCounter();
    }

    // --- Gemini API Functions ---
    async function callGemini(prompt) {
        const modal = document.getElementById('geminiModal');
        const loading = document.getElementById('geminiLoading');
        const output = document.getElementById('geminiOutput');

        modal.classList.add('visible');
        loading.style.display = 'block';
        output.innerHTML = '';

        if (['file:', 'content:'].includes(window.location.protocol)) {
            showNotification("Funkcje AI nie działają na plikach otwartych lokalnie. Proszę uruchomić aplikację przez serwer WWW.", "error", 10000);
            modal.classList.remove('visible');
            return null;
        }

        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{
                parts: [{ text: prompt }]
            }]
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                 const errorBody = await response.text();
                throw new Error(`API Error: ${response.statusText}. Body: ${errorBody}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("Otrzymano pustą odpowiedź z API.");
            }
        } catch (error) {
            console.error("Gemini API call error:", error);
            showNotification("Wystąpił błąd podczas komunikacji z AI.", "error");
            return null;
        } finally {
            loading.style.display = 'none';
        }
    }

    async function generateCompetitionAnnouncement() {
        if(competitors.length === 0) {
            showNotification("Najpierw dodaj zawodników do konkurencji.", "error");
            return;
        }

        const eventTitle = document.getElementById('eventTitle').textContent;
        const eventType = currentEventType === 'high' ? "w której więcej lub ciężej znaczy lepiej" : "w której wygrywa najkrótszy czas";
        const competitorList = competitors.join(', ');

        const prompt = `Jesteś profesjonalnym spikerem na zawodach strongman. Stwórz krótką, ale porywającą i energetyczną zapowiedź dla konkurencji o nazwie "${eventTitle}". To konkurencja, ${eventType}. Następujący zawodnicy wezmą udział: ${competitorList}. Twoim celem jest rozgrzanie publiczności i zachęcenie do głośnego dopingu. Zakończ zapowiedź motywacyjnym okrzykiem!`;

        const announcement = await callGemini(prompt);
        if (announcement) {
            const outputDiv = document.getElementById('geminiOutput');
            outputDiv.innerHTML = `<textarea readonly>${announcement}</textarea>`;
        }
    }

    async function generateEventName() {
        const location = document.getElementById('eventLocationInput').value.trim();
        if (!location) {
            showNotification("Wprowadź najpierw lokalizację zawodów, aby uzyskać lepszą sugestię nazwy.", "error");
            return;
        }

        const prompt = `Zaproponuj 5 krótkich, chwytliwych i robiących wrażenie nazw dla zawodów strongman odbywających się w "${location}". Zwróć każdą nazwę w nowej linii, bez numeracji i dodatkowych znaków.`;

        const namesText = await callGemini(prompt);
        if (namesText) {
            const names = namesText.split('\n').filter(n => n.trim() !== '');
            const outputDiv = document.getElementById('geminiOutput');
            outputDiv.innerHTML = '';
            names.forEach(name => {
                const btn = document.createElement('button');
                btn.textContent = name;
                btn.onclick = () => {
                    document.getElementById('eventNameInput').value = name;
                    document.getElementById('geminiModal').classList.remove('visible');
                };
                outputDiv.appendChild(btn);
            });
        }
    }

    // --- FULLSCREEN STOPWATCH ---
    function hapticFeedback() {
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    function formatTime(ms) {
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const hundredths = Math.floor((ms % 1000) / 10);
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(hundredths).padStart(2, '0')}`;
    }

    function updateStopwatchDisplay() {
        const currentTime = Date.now();
        stopwatchElapsedTime = currentTime - stopwatchStartTime;
        document.getElementById('fsTime').textContent = formatTime(stopwatchElapsedTime);
    }
    
    function setStopwatchMode(mode) {
        if (isStopwatchRunning) return;

        const stopwatchContainer = document.getElementById('fullscreenStopwatch');
        const repsBtn = document.getElementById('fsRepsBtn');
        const lapsBtn = document.getElementById('fsLapsBtn');

        if (stopwatchMode === mode) {
            stopwatchMode = 'none';
            stopwatchContainer.classList.remove('mode-selected');
            repsBtn.classList.remove('selected');
            lapsBtn.classList.remove('selected');
        } else {
            stopwatchMode = mode;
            stopwatchContainer.classList.add('mode-selected');
            repsBtn.classList.toggle('selected', mode === 'reps');
            lapsBtn.classList.toggle('selected', mode === 'laps');
        }
    }

    function startStopwatch() {
        if (isStopwatchRunning) return;
        hapticFeedback();
        isStopwatchRunning = true;
        stopwatchStartTime = Date.now() - stopwatchElapsedTime;
        stopwatchInterval = setInterval(updateStopwatchDisplay, 10);

        const startStopBtn = document.getElementById('fsStartStopBtn');
        startStopBtn.textContent = 'Stop';
        startStopBtn.classList.add('stop-state');
        document.getElementById('fsPostStopControls').style.display = 'none';

        const stopwatchContainer = document.getElementById('fullscreenStopwatch');
        if (stopwatchMode !== 'none') {
            stopwatchContainer.classList.add('mode-selected');
        }
        
        if (stopwatchMode === 'reps') {
            document.getElementById('fsRepsDisplay').style.display = 'block';
        }
    }

    function stopStopwatch() {
        if (!isStopwatchRunning) return;
        hapticFeedback();
        isStopwatchRunning = false;
        clearInterval(stopwatchInterval);
        stopwatchElapsedTime = Date.now() - stopwatchStartTime;
        document.getElementById('fsTime').textContent = formatTime(stopwatchElapsedTime);

        const startStopBtn = document.getElementById('fsStartStopBtn');
        startStopBtn.style.display = 'none';
        document.getElementById('fsPostStopControls').style.display = 'grid';

        if (stopwatchMode === 'laps' && lapTimes.length > 0) {
            showLapSelectionModal();
        }
    }
    
    function handleModeAction(type) {
        if (!isStopwatchRunning) {
            setStopwatchMode(type);
            return;
        }
        
        if (type === 'reps' && stopwatchMode === 'reps') {
            hapticFeedback();
            repCount++;
            document.getElementById('fsRepsDisplay').textContent = `${repCount} Powt.`;
        } else if (type === 'laps' && stopwatchMode === 'laps') {
            hapticFeedback();
            lapTimes.push(stopwatchElapsedTime);
            showNotification(`Zapisano międzyczas: ${formatTime(stopwatchElapsedTime)}`, 'info', 1500);
        }
    }

    function resetStopwatch() {
        hapticFeedback();
        if(isStopwatchRunning) {
            isStopwatchRunning = false;
            clearInterval(stopwatchInterval);
        }
        stopwatchElapsedTime = 0;
        repCount = 0;
        lapTimes = [];
        
        stopwatchMode = 'none';
        document.getElementById('fullscreenStopwatch').classList.remove('mode-selected');
        document.querySelectorAll('.fs-btn').forEach(btn => btn.classList.remove('selected'));

        document.getElementById('fsTime').textContent = formatTime(0);
        document.getElementById('fsRepsDisplay').textContent = `0 Powt.`;
        document.getElementById('fsRepsDisplay').style.display = 'none';
        
        const startStopBtn = document.getElementById('fsStartStopBtn');
        startStopBtn.textContent = 'Start';
        startStopBtn.classList.remove('stop-state');
        startStopBtn.style.display = 'flex';
        
        document.getElementById('fsPostStopControls').style.display = 'none';
    }

    async function enterFullscreenStopwatch(competitorName) {
        const elem = document.getElementById('fullscreenStopwatch');
        try {
            if (document.fullscreenEnabled && !document.fullscreenElement) {
                await elem.requestFullscreen?.();
            }
        } catch(err) {
            console.warn("Fullscreen API not available or was rejected.", err);
        }

        currentStopwatchCompetitor = competitorName;
        const profile = competitorProfiles[competitorName] || {};
        document.getElementById('fsCompetitorName').textContent = competitorName;
        document.getElementById('fsCompetitorPhoto').src = profile.photo || 'https://placehold.co/120x120/eee/333?text=?';

        elem.classList.add('visible');
        resetStopwatch();
        await saveCheckpoint(`Stoper ${stopwatchCheckpointCounter} (${competitorName})`);
        stopwatchCheckpointCounter++;
    }

    function exitFullscreenStopwatch() {
        if (document.fullscreenElement) {
            document.exitFullscreen();
        }
        document.getElementById('fullscreenStopwatch').classList.remove('visible');
    }
    
    // MODIFIED FUNCTION with numbering and styling
    function showLapSelectionModal() {
        const list = document.getElementById('fsLapsModalList');
        list.innerHTML = '';
        lapTimes.forEach((lap, index) => {
            const item = document.createElement('div');
            item.className = 'lap-item';
            item.textContent = `${index + 1}. ${formatTime(lap)}`; // Added numbering
            item.onclick = () => {
                saveStopwatchTime(lap);
                document.getElementById('fsLapsModal').classList.remove('visible');
            };
            list.appendChild(item);
        });
        document.getElementById('fsLapsModal').classList.add('visible');
    }

    function saveStopwatchTime(valueToSave = null) {
        hapticFeedback();
        const input = document.querySelector(`#resultsTable .resultInput[data-name="${CSS.escape(currentStopwatchCompetitor)}"]`);
        if (input) {
            let result;
            switch(stopwatchMode) {
                case 'reps':
                    result = repCount;
                    setEventType('high'); 
                    break;
                case 'laps':
                    result = (valueToSave / 1000).toFixed(2);
                    setEventType('low'); 
                    break;
                case 'none':
                default:
                    result = (stopwatchElapsedTime / 1000).toFixed(2);
                    setEventType('low'); 
                    break;
            }
            input.value = result;
            triggerAutoSave();
        }
        exitFullscreenStopwatch();
    }

    // --- INITIALIZATION & EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        await initDB();
        await seedDatabaseIfNeeded();

        const themeSelector = document.getElementById('themeSelector');
        const savedTheme = localStorage.getItem('strongmanTheme') || 'light';
        document.body.className = savedTheme;
        themeSelector.value = savedTheme;

        themeSelector.addEventListener('change', (e) => {
          const theme = e.target.value;
          document.body.className = theme;
          localStorage.setItem('strongmanTheme', theme);
        });

        const loadedFromAutoSave = await loadState('strongmanState_autoSave');

        if (!loadedFromAutoSave) {
            await populateFullCompetitorList();
            const savedLogo = localStorage.getItem('strongmanLogo');
            if (savedLogo) {
                document.getElementById('logoImg').src = savedLogo;
                logoData = savedLogo;
                document.getElementById('selectLogoBtn').style.display = 'none';
            }
            const savedEventMeta = localStorage.getItem('eventMeta');
            if (savedEventMeta) {
              const meta = JSON.parse(savedEventMeta);
              document.getElementById('eventNameInput').value = meta.name || '';
              document.getElementById('eventLocationInput').value = meta.location || '';
            }
        }
      } catch (e) {
        console.error("Initialization failed:", e);
        showNotification("Wystąpił krytyczny błąd podczas inicjalizacji.", "error", 5000);
      }

      const saveMeta = () => { localStorage.setItem('eventMeta', JSON.stringify({ name: document.getElementById('eventNameInput').value, location: document.getElementById('eventLocationInput').value })); };
      document.getElementById('eventNameInput').addEventListener('input', saveMeta);
      document.getElementById('eventLocationInput').addEventListener('input', saveMeta);
      document.getElementById('eventTitle').addEventListener('input', triggerAutoSave);

      document.getElementById('mainContent').addEventListener('click', (e) => {
        if (e.target.classList.contains('resultInput') && !e.target.readOnly) {
          const competitorName = e.target.dataset.name;
          const competitorIndex = competitors.findIndex(c => c === competitorName);
          if (competitorIndex !== -1) { openFocusMode(competitorIndex); }
        }
      });

      document.getElementById('closeFocusBtn').addEventListener('click', closeFocusMode);
      document.getElementById('focusModeModal').addEventListener('click', (e) => { if (e.target.id === 'focusModeModal') { closeFocusMode(); } });
      document.getElementById('focusPrevBtn').addEventListener('click', () => navigateFocusMode(-1));
      document.getElementById('focusNextBtn').addEventListener('click', () => navigateFocusMode(1));
      document.getElementById('focusConfirmNextBtn').addEventListener('click', () => {
          saveFocusInput();
          if (focusModeIndex === competitors.length - 1) { closeFocusMode(); }
          else { navigateFocusMode(1); }
      });
      document.getElementById('focusResultInput').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); document.getElementById('focusConfirmNextBtn').click(); }
      });
      document.getElementById('categoryFilters').addEventListener('click', (e) => {
        if(e.target.classList.contains('filter-btn')) {
            document.querySelectorAll('#categoryFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            filterCompetitorSelectionList(e.target.dataset.filter);
        }
      });
      document.getElementById('addPastedBtn').addEventListener('click', processPastedCompetitors);

      const searchInput = document.getElementById('competitorSearch');
      const searchResultsContainer = document.getElementById('competitorSearchResults');
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        searchResultsContainer.innerHTML = '';
        if (query.length < 1) { searchResultsContainer.style.display = 'none'; return; }

        searchResultsContainer.style.display = 'block';
        const matches = allDbCompetitors.filter(c => c.name.toLowerCase().includes(query));
        if (matches.length === 0) {
            searchResultsContainer.innerHTML = '<div class="search-result-item">Brak wyników</div>';
        } else {
            matches.forEach(c => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = c.name;
                item.onclick = () => {
                    const checkbox = document.querySelector(`#competitorSelectionList input[value="${CSS.escape(c.name)}"]`);
                    if(checkbox) checkbox.checked = true;
                    searchInput.value = '';
                    searchResultsContainer.style.display = 'none';
                    updateSelectionCounter();
                };
                searchResultsContainer.appendChild(item);
            });
        }
      });

      document.addEventListener('click', function (e) {
          const searchContainer = document.getElementById('competitorSearchContainer');
          if (!searchContainer.contains(e.target)) {
              searchResultsContainer.style.display = 'none';
          }

          const info = e.target.closest('.tie-info');
          if (info) {
              e.preventDefault();
              info.classList.toggle('tooltip-active');
              document.querySelectorAll('.tie-info.tooltip-active').forEach(otherInfo => {
                  if (otherInfo !== info) {
                      otherInfo.classList.remove('tooltip-active');
                  }
              });
              setTimeout(() => {
                  info.classList.remove('tooltip-active');
              }, 4000);
          } else if (!e.target.closest('.tooltip')) {
              document.querySelectorAll('.tie-info.tooltip-active').forEach(el => el.classList.remove('tooltip-active'));
          }
      });

      document.getElementById('logoImg').addEventListener('dblclick', async () => {
        if (!logoData) { return; }
        if (await showConfirmation("Czy na pewno chcesz usunąć to logo?")) {
            removeLogo();
        }
      });

      const toggleBtn = document.getElementById('toggleTableWidthBtn');
      const tableWrapper = document.querySelector('.table-wrapper');

      const isTableExpanded = localStorage.getItem('isTableExpanded') === 'true';
      if (isTableExpanded) {
          tableWrapper.classList.add('expanded');
          toggleBtn.textContent = 'Zwiń Tabelę';
      } else {
          toggleBtn.textContent = 'Rozwiń Tabelę';
      }

      toggleBtn.addEventListener('click', () => {
          tableWrapper.classList.toggle('expanded');
          const isNowExpanded = tableWrapper.classList.contains('expanded');
          localStorage.setItem('isTableExpanded', isNowExpanded);
          toggleBtn.textContent = isNowExpanded ? 'Zwiń Tabelę' : 'Rozwiń Tabelę';
      });

      document.getElementById('generateAnnounceBtn').addEventListener('click', generateCompetitionAnnouncement);
      document.getElementById('generateEventNameBtn').addEventListener('click', generateEventName);
      document.getElementById('geminiCloseBtn').addEventListener('click', () => {
          document.getElementById('geminiModal').classList.remove('visible');
      });

      const focusInput = document.getElementById('focusResultInput');
      const focusModalOverlay = document.getElementById('focusModeModal');
      focusInput.addEventListener('focus', () => {
        if (window.innerWidth <= 768) {
          focusModalOverlay.classList.add('keyboard-active');
        }
      });
      focusInput.addEventListener('blur', () => {
        focusModalOverlay.classList.remove('keyboard-active');
      });

      // Fullscreen Stopwatch Listeners
      document.getElementById('fsStartStopBtn').addEventListener('click', () => {
        if (isStopwatchRunning) {
            stopStopwatch();
        } else {
            startStopwatch();
        }
      });
       document.getElementById('fsDisplayArea').addEventListener('click', () => {
         if (isStopwatchRunning) {
            handleModeAction(stopwatchMode);
         }
      });
      document.getElementById('fsRepsBtn').addEventListener('click', () => handleModeAction('reps'));
      document.getElementById('fsLapsBtn').addEventListener('click', () => handleModeAction('laps'));
      document.getElementById('fsResetBtn').addEventListener('click', resetStopwatch);
      document.getElementById('fsSaveBtn').addEventListener('click', () => saveStopwatchTime(stopwatchElapsedTime));
      document.getElementById('fsExitBtn').addEventListener('click', (e) => {
        e.preventDefault();
        exitFullscreenStopwatch();
      });

      document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) {
          exitFullscreenStopwatch();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (document.getElementById('fullscreenStopwatch').classList.contains('visible')) {
           if (e.key === 'Escape') {
            exitFullscreenStopwatch();
           }
        }
      });

    });
  </script>
</body>
</html>
