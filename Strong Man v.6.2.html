<!DOCTYPE html>
<html lang="pl">
<head>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta charset="utf-8"/>
  <title>Strongman – Zawody v.6.0 (Gemini AI)</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #27ae60;
      --error-color: #e74c3c;
      --info-color: #f1c40f;
      --light-gray: #f8f9fa;
      --medium-gray: #ddd;
      --dark-gray: #333;
      --white: #ffffff;
      --shadow-light: 0 5px 15px rgba(0,0,0,0.07);
      --shadow-dark: 0 6px 12px rgba(0,0,0,0.15);
      --gemini-glow: 0 0 15px rgba(52, 152, 219, 0.6);
    }

    body.dark {
      --light-gray: #333;
      --medium-gray: #666;
      --dark-gray: #ecf0f1;
      --white: #2c3e50;
      --primary-color: #ecf0f1;
      background-color: #2c3e50;
      color: #ecf0f1;
    }
    body.dark .event-meta-header, 
    body.dark .header, 
    body.dark .intro-container, 
    body.dark .panel {
      background-color: #34495e;
    }
    body.dark th {
      background-color: #2c3e50;
    }
    body.dark input, 
    body.dark textarea, 
    body.dark select {
      background-color: #2c3e50;
      color: #ecf0f1;
      border-color: #555;
    }

    body.contrast {
      --light-gray: #000;
      --medium-gray: #888;
      --dark-gray: #ff0;
      --white: #000;
      --primary-color: #ff0;
      --secondary-color: #ff0;
      --success-color: #0f0;
      --error-color: #f00;
      --info-color: #ff0;
      background-color: #000;
      color: #ff0;
    }
    body.contrast .event-meta-header, 
    body.contrast .header, 
    body.contrast .intro-container, 
    body.contrast .panel {
      background-color: #000;
      border: 2px solid #ff0;
    }
    body.contrast th {
      background-color: #111;
    }
    body.contrast input, 
    body.contrast textarea, 
    body.contrast select {
      background-color: #000;
      color: #ff0;
      border: 2px solid #ff0;
    }
    body.contrast button {
      border: 2px solid #ff0;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    html {
      font-size: 16px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 15px;
      background-color: var(--light-gray);
      color: var(--dark-gray);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    
    .event-meta-header, .header, .intro-container, .panel {
      background: var(--white);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-light);
      margin-bottom: 20px;
      transition: background-color 0.3s;
    }
    
    .event-meta-inputs { display: flex; gap: 15px; flex-wrap: wrap; }
    .event-meta-inputs input { flex: 1; min-width: 200px; }
    .header { text-align: center; }
    
    #logoImg[src] { cursor: pointer; }
    .logo-container { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; flex-direction: column; }
    #logoImg { max-height: 250px; max-width: 100%; margin-bottom: 15px; }
    .logo-actions { display: flex; gap: 10px; margin-top: 10px; }
    
    .logo-btn {
      padding: 6px 12px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer;
      background: var(--primary-color); color: var(--white); transition: all 0.2s;
    }
    .logo-btn:hover { opacity: 0.9; }
    .header h1 { font-size: 2.2rem; margin: 0 0 10px 0; color: var(--primary-color); }
    h2 { color: var(--primary-color); margin-top: 0; font-size: 1.8rem; }
    h3 { margin-top: 25px; margin-bottom: 10px; font-size: 1.2rem; color: #555; text-align: center; }
    
    textarea, input, select {
      font-size: 1rem; padding: 12px; margin: 5px 0 10px 0; width: 100%;
      border: 1px solid var(--medium-gray); border-radius: 8px; background-color: var(--white);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    textarea { height: 100px; }
    
    button {
      display: block; width: 100%; padding: 15px; font-size: 1.125rem; font-weight: bold; border: none;
      border-radius: 8px; cursor: pointer; background: linear-gradient(135deg, #27ae60, #219653);
      color: var(--white); margin: 15px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: all 0.2s ease;
    }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-dark); }
    button:active:not(:disabled) { transform: translateY(0); }
    button:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; transform: none; }
        
    #mainContent {
      display: none; background: var(--white); padding: 25px;
      border-radius: 12px; box-shadow: var(--shadow-light); margin-top: 20px;
    }
    
    .event-title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
    #eventTitle {
      font-size: 1.8rem; font-weight: bold; padding: 15px; border-radius: 8px; border: 2px dashed var(--medium-gray);
      background-color: var(--white); cursor: text; outline: none; width: 100%; text-align: center;
      flex-grow: 1;
    }
    .event-type-container { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    .type-btn {
      padding: 12px 15px; border-radius: 6px; cursor: pointer; background: #e0e0e0;
      border: none; font-size: 14px; transition: all 0.2s ease-in-out; white-space: nowrap;
    }
    .type-btn.active {
        background: var(--success-color);
        color: var(--white);
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(39, 174, 96, 0.7);
    }
    
    .actions-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr auto;
        margin: 20px 0;
        align-items: stretch;
    }
    .actions-grid button {
        margin: 0;
        font-size: 1.25rem;
        font-weight: bold;
        padding: 15px 10px;
        line-height: 1.2;
    }
    #generateEventNameBtn {
      aspect-ratio: 1/1;
      font-size: 1.8rem;
      padding: 10px;
    }

    
    #undo-redo-container {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
        margin: 20px 0;
    }
    #undo-redo-container button {
         margin: 0; font-size: 1rem; font-weight: normal; padding: 15px 10px;
    }

    #export-button-group {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
        margin: 20px 0;
    }
    #export-button-group button:nth-child(3) {
        grid-column: 1 / -1;
    }

    .security-panel .button-group {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr;
        margin: 20px 0;
    }
    
    #undoBtn { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    #redoBtn { background: linear-gradient(135deg, #2980b9, #3498db); }
    
    #toggleTableWidthBtn {
        width: 100%;
        margin: 15px 0 10px;
        background: var(--secondary-color);
        font-weight: normal;
        font-size: 1rem;
        padding: 10px;
    }

    .table-wrapper {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        transition: box-shadow 0.3s;
    }
    .table-wrapper.expanded {
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 8px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        table-layout: fixed; 
    }
    .table-wrapper.expanded table {
        table-layout: auto;
        width: auto;
        min-width: 100%;
    }
    
    th, td { 
      padding: 12px 5px; 
      text-align: center; 
      border-bottom: 1px solid #eee; 
      vertical-align: middle; 
      font-size: 1rem;
    }
    th {
      background-color: var(--light-gray);
      font-weight: 600;
      white-space: normal;
    }

    th:first-child, td:first-child {
        text-align: left;
        white-space: normal;
    }
    .table-wrapper.expanded td,
    .table-wrapper.expanded th {
        white-space: nowrap;
    }
    
    #resultsTable .resultInput { cursor: pointer; width: 95%; max-width: 80px; }
    input.resultInput:read-only { background-color: #f3f4f6; cursor: not-allowed; opacity: 0.7; }
    
    .gold td:first-child::before { content: "🥇 "; } .silver td:first-child::before { content: "🥈 "; } .bronze td:first-child::before { content: "🥉 "; }

    .competitor-cell { display: flex; align-items: center; gap: 10px; }
    .competitor-photo-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid var(--medium-gray); flex-shrink: 0;}
    .info-icon { cursor: pointer; font-size: 18px; color: var(--secondary-color); user-select: none; }
    
    #notification-bar, .modal-overlay { position: fixed; z-index: 1000; }
    #notification-bar {
      top: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px;
      color: var(--white); font-weight: bold; box-shadow: var(--shadow-dark); transition: top 0.4s ease-in-out;
      max-width: 90%; text-align: center;
    }
    #notification-bar.show { top: 20px; }
    #notification-bar.success { background-color: var(--success-color); }
    #notification-bar.error { background-color: var(--error-color); }
    #notification-bar.info { background-color: var(--info-color); color: var(--dark-gray); }

    .modal-overlay {
      top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6);
      display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, align-items 0.3s;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-box {
        background-color: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        max-width: 90%; width: 500px; text-align: center; max-height: 90vh; overflow-y: auto; position: relative;
        transition: margin-top 0.3s ease-out;
    }
    .modal-box p { margin: 0 0 20px 0; font-size: 1.125rem; }
    .modal-buttons { display: flex; gap: 15px; justify-content: center; }
    .modal-buttons button { width: auto; padding: 10px 25px; margin: 0; font-size: 1rem; }
    #confirmBtn, #promptConfirmBtn { background: var(--success-color); } 
    #cancelBtn, #promptCancelBtn { background: var(--error-color); }
    
    /* Styling for keyboard visibility on mobile */
    .modal-overlay.keyboard-active {
        align-items: flex-start;
    }
    .modal-overlay.keyboard-active .focus-mode-box {
        height: auto;
        margin-top: 2vh;
    }
    
    #competitorDetailModal .modal-box { text-align: left; }
    #competitorDetailPhoto { max-width: 150px; border-radius: 8px; margin: 0 auto 20px; display: block; box-shadow: var(--shadow-dark); }
    #competitorDetailNotes { background-color: #f9f9f9; padding: 15px; border-radius: 8px; min-height: 80px; white-space: pre-wrap; font-size: 14px; }
    #competitorDetailMeta { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; font-size: 15px; }
    #competitorDetailMeta p { margin: 0; padding: 5px; border-bottom: 1px solid #eee;}
    #competitorDetailMeta p strong { color: var(--primary-color); }

    @keyframes highlight-flash-anim { 0%, 100% { background-color: transparent; } 50% { background-color: rgba(46, 204, 113, 0.3); } }
    .highlight-flash { animation: highlight-flash-anim 1s ease-out; }

    .tie-info { display: inline-block; margin-left: 8px; font-weight: bold; color: var(--secondary-color); cursor: pointer; position: relative; }
    .tie-info .tooltip {
        visibility: hidden; width: 220px; background-color: var(--primary-color); color: var(--white); text-align: center;
        border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%;
        margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-weight: normal; pointer-events: none;
    }
    .tie-info .tooltip::after {
        content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px;
        border-style: solid; border-color: var(--primary-color) transparent transparent transparent;
    }
    .tie-info.tooltip-active .tooltip { visibility: visible; opacity: 1; }
    
    #competitorDbPanel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; align-items: center; justify-content: center; }
    #competitorDbPanel .modal-box { max-width: 800px; }
    #competitorListContainer { max-height: 35vh; overflow-y: auto; margin-top: 20px; border: 1px solid var(--medium-gray); border-radius: 8px; }
    .competitor-list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    .competitor-list-item:last-child { border-bottom: none; }
    .competitor-list-actions button { font-size: 14px; padding: 5px 10px; width: auto; margin: 0 5px; }
    #competitorForm .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    #competitorForm label { text-align: left; margin-bottom: -5px; font-size: 14px; color: #555; display: block; }

    .intro-container .filter-buttons { 
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px; 
        justify-content: center; 
        margin-bottom: 20px; 
    }
    .intro-container .filter-btn { 
        padding: 10px 15px; font-size: 14px; border: 1px solid var(--medium-gray); 
        border-radius: 20px; background-color: var(--white); color: var(--primary-color); 
        cursor: pointer; transition: all 0.2s;
    }
    .intro-container .filter-btn.active { background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color); }
    
    #competitorSelectionList { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; max-height: 40vh; overflow-y: auto; padding-top: 10px; border: 1px solid var(--medium-gray); border-radius: 8px; padding: 10px;}
    .competitor-select-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: #f9f9f9; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
    .competitor-select-item:hover { background: #eef; }
    .competitor-select-item input[type="checkbox"] { width: 20px; height: 20px; flex-shrink: 0; }
    #addPastedBtn { background: var(--secondary-color); font-size: 1rem; padding: 12px; margin-top: 5px; }

    #selectionCounter {
        text-align: right; font-size: 1rem; font-weight: bold;
        color: var(--primary-color); margin-top: 15px; padding: 10px;
        background-color: #e9ecef; border-radius: 8px;
    }

    #competitorSearchContainer { position: relative; margin-top: 15px;}
    #competitorSearchResults { position: absolute; background: white; width: 100%; border: 1px solid var(--medium-gray); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: var(--shadow-dark); }
    .search-result-item { padding: 10px; cursor: pointer; }
    .search-result-item:hover { background-color: #eef; }


    .focus-mode-box { max-width: 100%; width: 100%; height: 100%; max-height: 100vh; border-radius: 0; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
    #focusCompetitorInfo { margin-bottom: 20px; text-align: center; }
    #focusCompetitorPhoto { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--secondary-color); margin-bottom: 15px; }
    #focusCompetitorName { font-size: 1.8rem; color: var(--primary-color); margin: 0; }
    #focusResultInput { font-size: 3rem; text-align: center; padding: 20px; margin-bottom: 20px; border-width: 2px; }
    .focus-nav-buttons { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; }
    .focus-nav-buttons button { padding: 15px; font-size: 1rem; }
    #focusConfirmNextBtn { background: var(--success-color); }
    #focusPrevBtn, #focusNextBtn { background: var(--secondary-color); }
    .focus-close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 2.5rem; color: var(--dark-gray); cursor: pointer; padding: 0; width: auto; margin: 0; box-shadow: none; }

    .security-panel { margin-top: 25px; padding-top: 20px; border-top: 2px solid var(--medium-gray); }
    .security-panel h3 { text-align: left; }
    #checkpointList button { font-size: 14px; background: #f0f0f0; color: #333; margin: 5px; width: calc(50% - 10px);}
    #checkpointList { display: flex; flex-wrap: wrap; }

    #saveIndicator {
        position: fixed; top: 20px; right: 20px; font-size: 24px;
        opacity: 0; transition: opacity 0.5s ease-in-out;
        z-index: 2000; pointer-events: none;
    }
    #saveIndicator.visible { opacity: 1; }

    .theme-selector {
      position: absolute; top: 20px; right: 20px; background: var(--white);
      padding: 8px 12px; border-radius: 6px; box-shadow: var(--shadow-light);
    }
    
    /* Gemini AI Button Styles */
    .gemini-btn {
        background: linear-gradient(135deg, #4e54c8, #8f94fb);
        box-shadow: 0 0 10px var(--gemini-glow);
        margin: 0;
    }
    .gemini-btn-small {
        background: linear-gradient(135deg, #4e54c8, #8f94fb);
        padding: 0;
        font-size: 1.5rem;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        box-shadow: 0 0 8px var(--gemini-glow);
        margin: 0 0 0 10px;
        width: 2.5rem; /* Set width for square shape */
        height: 2.5rem; /* Set height for square shape */
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        flex-shrink: 0;
    }
    #gemini-output textarea {
      width: 100%;
      height: 200px;
      margin-top: 15px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      font-size: 1rem;
      resize: vertical;
    }
    body.dark #gemini-output textarea {
        background-color: #2c3e50;
        color: #ecf0f1;
        border-color: #555;
    }
    #gemini-output button {
        margin: 8px 0;
        font-size: 1rem;
    }

    /* Globalne skalowanie dla widoku mobilnego */
    @media (max-width: 768px) {
      html {
        font-size: 12px;
      }
      body {
        padding: 10px;
      }
      .event-meta-header, .header, .intro-container, .panel {
        padding: 15px;
      }
      #eventTitle { font-size: 1.5rem; }
      .event-title-container { flex-direction: column; align-items: stretch; }
      #competitorForm .form-grid { grid-template-columns: 1fr; }
      .modal-box { width: 95%; }
      .theme-selector { position: static; margin: 10px auto; width: fit-content; }
    }
    @media (max-width: 370px) {
        html {
            font-size: 11px;
        }
        .competitor-cell {
            gap: 5px;
        }
        .competitor-photo-thumb {
            width: 30px;
            height: 30px;
        }
    }
  </style>
</head>
<body>

  <div id="notification-bar"></div>
  <div id="saveIndicator">💾</div>

  <div id="confirmation-modal" class="modal-overlay">
    <div class="modal-box">
      <p id="modal-text"></p>
      <div class="modal-buttons">
        <button id="confirmBtn">Tak</button> <button id="cancelBtn">Anuluj</button>
      </div>
    </div>
  </div>
  <div id="prompt-modal" class="modal-overlay">
      <div class="modal-box">
          <p id="prompt-text"></p>
          <input type="text" id="promptInput" placeholder="Wprowadź nazwę...">
          <div class="modal-buttons">
              <button id="promptConfirmBtn">Zapisz</button>
              <button id="promptCancelBtn">Anuluj</button>
          </div>
      </div>
  </div>
  <!-- Gemini Modal -->
  <div id="gemini-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 id="gemini-modal-title">✨ Sugestie od Gemini</h3>
      <div id="gemini-loading" style="display: none; font-size: 1.2rem; padding: 20px 0;">Generowanie...</div>
      <div id="gemini-output"></div>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button id="geminiCloseBtn">Zamknij</button>
      </div>
    </div>
  </div>

  <div id="competitorDetailModal" class="modal-overlay" onclick="this.classList.remove('visible')">
      <div class="modal-box" onclick="event.stopPropagation()">
          <h3 id="competitorDetailName" style="text-align: center;"></h3>
          <img id="competitorDetailPhoto" src="" alt="Zdjęcie zawodnika">
          <div id="competitorDetailMeta"></div>
          <h4>Osiągnięcia / Notatki:</h4>
          <p id="competitorDetailNotes"></p>
          <button onclick="document.getElementById('competitorDetailModal').classList.remove('visible')" style="font-size: 16px; padding: 10px;">Zamknij</button>
      </div>
  </div>
  <div id="competitorDbPanel">
    <div class="modal-box">
      <h2>Baza Danych Zawodników</h2>
      <form id="competitorForm">
        <input type="hidden" id="competitorId">
        <label for="competitorName">Imię i nazwisko</label>
        <input type="text" id="competitorName" placeholder="Imię i nazwisko" required>
        
        <div class="form-grid">
            <div><label for="birthDate">Data urodzenia</label><input type="date" id="birthDate"></div>
            <div><label for="residence">Miejsce zamieszkania</label><input type="text" id="residence" placeholder="np. Malbork"></div>
            <div><label for="height">Wzrost (cm)</label><input type="number" id="height" placeholder="np. 186"></div>
            <div><label for="weight">Waga (kg)</label><input type="number" id="weight" placeholder="np. 140"></div>
        </div>
        
        <label for="category">Kategoria</label>
        <select id="category">
          <option value="Aktywny Zawodnik">Aktywny Zawodnik</option>
          <option value="Gwiazda">Gwiazda</option>
          <option value="Legenda">Legenda</option>
          <option value="Weteran">Weteran</option>
          <option value="Lokalny">Lokalny</option>
        </select>

        <label for="competitorNotes">Osiągnięcia / Notatki</label>
        <textarea id="competitorNotes" placeholder="Najważniejsze osiągnięcia, rekordy, informacje..."></textarea>
        
        <label for="competitorPhoto">Zdjęcie</label>
        <input type="file" id="competitorPhoto" accept="image/*">
        
        <button type="submit" id="competitorFormBtn">Dodaj Zawodnika</button>
      </form>
      <div id="competitorListContainer"></div>
      <button onclick="closeDbPanel()" style="background: var(--primary-color);">Zamknij Panel</button>
    </div>
  </div>
  <div id="focusModeModal" class="modal-overlay">
      <div class="modal-box focus-mode-box">
          <button id="closeFocusBtn" class="focus-close-btn" aria-label="Zamknij tryb skupienia">×</button>
          <div id="focusCompetitorInfo">
              <img id="focusCompetitorPhoto" src="" alt="Zdjęcie zawodnika">
              <h3 id="focusCompetitorName"></h3>
          </div>
          <input type="text" inputmode="decimal" id="focusResultInput" placeholder="Wprowadź wynik...">
          <div class="focus-nav-buttons">
              <button id="focusPrevBtn">Poprzedni</button>
              <button id="focusConfirmNextBtn">Zatwierdź i Następny</button>
              <button id="focusNextBtn">Następny</button>
          </div>
      </div>
  </div>

  <div class="theme-selector">
    <label for="themeSelector">Motyw:</label>
    <select id="themeSelector">
      <option value="light">Jasny</option>
      <option value="dark">Ciemny</option>
      <option value="contrast">Kontrastowy</option>
    </select>
  </div>
  
  <div class="event-meta-header">
    <div class="event-meta-inputs">
      <input type="text" id="eventName" placeholder="Nazwa imprezy">
      <input type="text" id="eventLocation" placeholder="Miejsce imprezy">
    </div>
    <div class="actions-grid">
        <button onclick="openDbPanel()">Zarządzaj Bazą Zawodników</button>
        <button id="generateEventNameBtn" class="gemini-btn" title="Zaproponuj nazwę imprezy">✨</button>
    </div>
  </div>
  
  <div class="header">
    <div class="logo-container">
      <img id="logoImg" src="" alt="Logo zawodów">
      <div class="logo-actions">
        <button id="selectLogoBtn" class="logo-btn" onclick="document.getElementById('logoUpload').click()">Wybierz logo</button>
      </div>
      <input type="file" id="logoUpload" accept="image/*" style="display:none" onchange="handleLogoUpload(event)">
    </div>
    <h1>🏋️‍♂️ ZAWODY STRONGMAN 🏋️‍♀️</h1>
    <p>System zarządzania zawodami siłaczy</p>
  </div>
  
  <div id="intro">
    <div class="intro-container">
      <h2>Wybierz zawodników</h2>
      <p>Filtruj wg kategorii, aby zawęzić listę. Zaznaczenia są zachowywane pomiędzy filtrami.</p>
      
      <div class="filter-buttons" id="categoryFilters">
        <button class="filter-btn active" data-filter="all">Wszyscy</button>
        <button class="filter-btn" data-filter="Legenda">Legendy</button>
        <button class="filter-btn" data-filter="Gwiazda">Gwiazdy</button>
        <button class="filter-btn" data-filter="Aktywny Zawodnik">Aktywni</button>
        <button class="filter-btn" data-filter="Weteran">Weterani</button>
        <button class="filter-btn" data-filter="Lokalny">Lokalni</button>
      </div>

      <div id="competitorSelectionList">
        <p>Ładowanie zawodników z bazy...</p>
      </div>
      <div id="selectionCounter">Wybrano: 0</div>

      <div id="competitorSearchContainer">
        <input type="text" id="competitorSearch" placeholder="Wyszukaj i dodaj zawodnika z bazy...">
        <div id="competitorSearchResults"></div>
      </div>

      <h3>...lub wklej listę zawodników</h3>
      <textarea id="pastedCompetitors" placeholder="Wklej listę zawodników, po jednym w każdej linii..."></textarea>
      <button id="addPastedBtn">Dodaj zawodników z listy</button>

      
<!-- NOWE KAFELKI ZABEZPIECZEŃ Z PRZED ROZPOCZĘCIA ZAWODÓW -->
<div class="security-panel">
  <h3>🛡️ Zabezpieczenia przed startem</h3>
  <div class="button-group">
    <button onclick="exportStateToFile()">Eksportuj stan do pliku</button>
    <button onclick="importStateFromFile()">Importuj stan z pliku</button>
  </div>
  <input type="file" id="importFile" accept=".json" style="display:none;" onchange="handleFileImport(event)">
</div>

<button onclick="startCompetition()">Rozpocznij zawody</button>
    </div>
  </div>
  
  <div id="mainContent">
    <div class="event-title-container">
      <div id="eventTitle" contenteditable="true">Konkurencja 1</div>
      <button id="generateAnnounceBtn" class="gemini-btn-small" title="Wygeneruj zapowiedź konkurencji (Gemini AI)">✨</button>
    </div>
    <div class="event-type-container">
        <button id="highTypeBtn" class="type-btn active" onclick="setEventType('high')">⬆️ Więcej = lepiej</button>
        <button id="lowTypeBtn" class="type-btn" onclick="setEventType('low')">⬇️ Mniej = lepiej</button>
    </div>
    
    <div class="actions-grid">
      <button onclick="shuffleCompetitors()">Wylosuj</button>
      <button onclick="showResults()">Wyniki</button>
      <button onclick="nextEvent()">Następna konk.</button>
      <button onclick="lastEvent()">Konkurencja Finałowa</button>
      <button onclick="calculatePoints()">Przyznaj punkty</button>
      <button onclick="showFinalSummary()">Podsumowanie</button>
    </div>
    
    <button id="toggleTableWidthBtn">Pokaż pełną tabelę</button>
    <div class="table-wrapper">
        <table id="resultsTable">
          <thead>
            <tr><th>Zawodnik</th><th>Wynik</th><th>M-ce</th><th>Pkt.</th><th>Suma</th></tr>
          </thead>
          <tbody></tbody>
        </table>
    </div>

    <div id="undo-redo-container">
        <button id="undoBtn" onclick="undoLastAction()" disabled>Cofnij</button>
        <button id="redoBtn" onclick="redoLastAction()" disabled>Powtórz</button>
    </div>
    
    <div class="panel" id="historyPanel" style="display:none;">
      <h3>Historia konkurencji</h3>
      <div id="eventList"></div>
      <div class="panel" id="eventDetails"></div>
    </div>
    
    <div id="export-button-group">
      <button onclick="exportResultsHTML()">Eksport HTML</button>
      <button onclick="exportToPDF()">Eksport do PDF</button>
      <button onclick="resetCompetition()" style="background:var(--error-color)">Resetuj</button>
    </div>

    <div class="panel security-panel">
        <h3>🛡️ Zabezpieczenia i Kopie Zapasowe</h3>
        <div class="button-group">
            <button onclick="saveCheckpoint()">Zapisz Punkt Kontrolny</button>
            <button onclick="showCheckpoints()">Wczytaj Punkt Kontrolny</button>
            <button onclick="exportStateToFile()">Eksportuj stan do pliku</button>
            <button onclick="importStateFromFile()">Importuj stan z pliku</button>
        </div>
        <input type="file" id="importFile2" accept=".json" style="display:none;" onchange="handleFileImport(event)">
        <div id="checkpointListContainer" style="display:none; margin-top:15px;">
            <h4>Dostępne punkty kontrolne:</h4>
            <div id="checkpointList"></div>
        </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // GLOBAL STATE
    let competitors = [], scores = {}, eventNumber = 1, eventHistory = [], logoData = null, currentEventType = 'high';
    let undoHistory = [], redoHistory = [];
    let db;
    let allDbCompetitors = [];
    let competitorProfiles = {}; 
    let focusModeIndex = -1;
    let autoSaveTimer;

    // --- DATABASE (IndexedDB) ---
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("StrongmanDB_v3", 1);
        request.onerror = e => { showNotification("Błąd otwierania bazy danych: " + e.target.error, "error"); reject(e); };
        request.onsuccess = e => { db = e.target.result; resolve(); };
        request.onupgradeneeded = e => {
          let db = e.target.result;
          if (!db.objectStoreNames.contains('competitors')) {
            const store = db.createObjectStore('competitors', { keyPath: 'id', autoIncrement: true });
            store.createIndex('name', 'name', { unique: true });
          }
        };
      });
    }
    
    async function seedDatabaseIfNeeded() {
        const dbCompetitors = await getCompetitorsFromDb();
        if (dbCompetitors.length === 0) {
            showNotification('Wykryto pustą bazę. Dodaję listę polskich zawodników...', 'info');
            const initialCompetitors = [
                { name: 'Mariusz Pudzianowski', category: 'Legenda', notes: '5x Mistrz Świata Strongman', photo: 'https://placehold.co/150x150/2c3e50/ffffff?text=Pudzian' },
                { name: 'Mateusz Kieliszkowski', category: 'Gwiazda', notes: '5x Mistrz Polski, wielokrotny wicemistrz Świata i Arnold Strongman Classic', photo: 'https://placehold.co/150x150/e74c3c/ffffff?text=Kielich' },
                { name: 'Krzysztof Radzikowski', category: 'Aktywny Zawodnik', notes: 'Zwycięzca Strongman Champions League 2013', photo: 'https://placehold.co/150x150/8e44ad/ffffff?text=Radzik' },
                { name: 'Oskar Ziółkowski', category: 'Aktywny Zawodnik', notes: 'Mistrz Polski Strongman 2021', photo: 'https://placehold.co/150x150/34495e/ffffff?text=Ziółek' },
                { name: 'Marek Czajkowski', category: 'Aktywny Zawodnik', notes: 'Mistrz Polski Strongman 2022, 2023', photo: 'https://placehold.co/150x150/7f8c8d/ffffff?text=Czajnik' },
                { name: 'Jarosław Dymek', category: 'Weteran', notes: '3x Mistrz Polski, Zwycięzca Drużynowych MŚ', photo: 'https://placehold.co/150x150/5e8a80/ffffff?text=Dymek' },
                { name: 'Sebastian Wenta', category: 'Weteran', notes: 'Wicemistrz Świata Strongman 2007', photo: 'https://placehold.co/150x150/8e44ad/ffffff?text=Wenta' }
            ];
            for (const competitor of initialCompetitors) {
                const fullCompetitor = {
                    name: competitor.name || 'Brak', category: competitor.category || 'Lokalny',
                    birthDate: '', residence: '', height: '', weight: '',
                    notes: competitor.notes || '',
                    photo: competitor.photo || `https://placehold.co/150x150/eee/333?text=${competitor.name.substring(0,1)}`
                };
                await addCompetitorToDb(fullCompetitor);
            }
        }
    }

    function dbAction(storeName, mode, action, data) {
      return new Promise((resolve, reject) => {
        if (!db) { reject("Baza danych nie jest zainicjowana."); return; }
        const transaction = db.transaction(storeName, mode);
        const store = transaction.objectStore(storeName);
        const request = action(store, data);
        transaction.oncomplete = () => {};
        request.onerror = e => reject(e);
        request.onsuccess = e => resolve(e.target.result);
      });
    }

    async function addCompetitorToDb(competitor) { return await dbAction('competitors', 'readwrite', (store, data) => store.add(data), competitor); }
    async function updateCompetitorInDb(competitor) { return await dbAction('competitors', 'readwrite', (store, data) => store.put(data), competitor); }
    async function deleteCompetitorFromDb(id) { return await dbAction('competitors', 'readwrite', (store, data) => store.delete(data), id); }
    async function getCompetitorsFromDb() { return await dbAction('competitors', 'readonly', (store) => store.getAll()); }

    function openDbPanel() { document.getElementById('competitorDbPanel').style.display = 'flex'; renderDbCompetitorList(); }
    function closeDbPanel() {
      document.getElementById('competitorDbPanel').style.display = 'none';
      document.getElementById('competitorForm').reset();
      document.getElementById('competitorId').value = '';
      document.getElementById('competitorFormBtn').textContent = 'Dodaj Zawodnika';
    }

    async function renderDbCompetitorList() {
      const dbCompetitors = (await getCompetitorsFromDb()).sort((a,b) => a.name.localeCompare(b.name));
      const container = document.getElementById('competitorListContainer');
      if (dbCompetitors.length === 0) {
        container.innerHTML = '<p style="padding: 20px; text-align:center;">Brak zawodników w bazie. Dodaj pierwszego!</p>';
        return;
      }
      container.innerHTML = dbCompetitors.map(c => `
        <div class="competitor-list-item">
          <div class="competitor-cell">
            <img src="${c.photo || 'https://placehold.co/40x40/eee/333?text=?'}" class="competitor-photo-thumb">
            <span>${c.name} <small>(${c.category || 'Brak'})</small></span>
          </div>
          <div class="competitor-list-actions">
            <button onclick="editCompetitor(${c.id})">Edytuj</button>
            <button onclick="confirmDeleteCompetitor(${c.id})" style="background:var(--error-color);">Usuń</button>
          </div>
        </div>
      `).join('');
    }
    
    async function populateFullCompetitorList() {
        allDbCompetitors = (await getCompetitorsFromDb()).sort((a, b) => a.name.localeCompare(b.name));
        competitorProfiles = {};
        allDbCompetitors.forEach(c => competitorProfiles[c.name] = c);

        const container = document.getElementById('competitorSelectionList');
        if (allDbCompetitors.length === 0) {
            container.innerHTML = `<p style="text-align:center; padding: 20px;">Baza danych jest pusta. Dodaj zawodników, aby rozpocząć.</p>`;
            return;
        }
        container.innerHTML = allDbCompetitors.map(c => `
            <label class="competitor-select-item" data-category="${c.category || 'Lokalny'}">
              <input type="checkbox" value="${c.name}">
              <img src="${c.photo || 'https://placehold.co/40x40/eee/333?text=?'}" class="competitor-photo-thumb">
              <span>${c.name}</span>
            </label>
        `).join('');
        
        container.addEventListener('change', updateSelectionCounter);
        filterCompetitorSelectionList('all');
        updateSelectionCounter();
    }
    
    function filterCompetitorSelectionList(filter) {
        document.querySelectorAll('#competitorSelectionList .competitor-select-item').forEach(item => {
            const itemCategory = item.dataset.category;
            if (filter === 'all' || itemCategory === filter) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function updateSelectionCounter() {
        const count = document.querySelectorAll('#competitorSelectionList input:checked').length;
        document.getElementById('selectionCounter').textContent = `Wybrano: ${count}`;
    }

    // --- [POPRAWKA] Zaktualizowana logika formularza z obsługą nadpisywania ---
    document.getElementById('competitorForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('competitorId').value;
        const name = document.getElementById('competitorName').value.trim();
        const photoFile = document.getElementById('competitorPhoto').files[0];

        if (!name) {
            showNotification("Imię i nazwisko są wymagane.", "error");
            return;
        }

        const competitorData = {
            name,
            birthDate: document.getElementById('birthDate').value,
            residence: document.getElementById('residence').value.trim(),
            height: document.getElementById('height').value,
            weight: document.getElementById('weight').value,
            notes: document.getElementById('competitorNotes').value.trim(),
            category: document.getElementById('category').value,
        };

        let photoData = null;
        if (photoFile) {
            photoData = await toBase64(photoFile);
        }
        
        if (id) {
            // Logika aktualizacji (tryb edycji)
            const existing = allDbCompetitors.find(c => c.id === parseInt(id));
            competitorData.id = parseInt(id);
            competitorData.photo = photoData || (existing ? existing.photo : null);
            await updateCompetitorInDb(competitorData);
            showNotification("Zaktualizowano zawodnika!", "success");
        } else {
            // Logika dodawania (sprawdza duplikaty)
            const existingCompetitor = allDbCompetitors.find(c => c.name.toLowerCase() === name.toLowerCase());

            if (existingCompetitor) {
                // Znaleziono zawodnika o tej samej nazwie. Pytamy o nadpisanie.
                const confirmed = await showConfirmation(`Zawodnik "${name}" już istnieje w bazie. Czy chcesz nadpisać jego dane?`);
                if (confirmed) {
                    // Użytkownik potwierdził. Aktualizujemy istniejący rekord.
                    competitorData.id = existingCompetitor.id;
                    competitorData.photo = photoData || existingCompetitor.photo;
                    await updateCompetitorInDb(competitorData);
                    showNotification(`Dane zawodnika "${name}" zostały nadpisane!`, "success");
                } else {
                    // Użytkownik anulował.
                    showNotification("Operacja anulowana.", "info");
                    return; 
                }
            } else {
                // Zawodnik nie istnieje. Dodajemy nowego.
                try {
                    competitorData.photo = photoData;
                    await addCompetitorToDb(competitorData);
                    showNotification("Dodano nowego zawodnika!", "success");
                } catch (error) {
                    console.error("Error adding competitor:", error);
                    showNotification("Wystąpił nieoczekiwany błąd podczas dodawania zawodnika.", "error");
                    return;
                }
            }
        }

        // Zamykamy panel i odświeżamy listy
        closeDbPanel();
        await renderDbCompetitorList();
        await populateFullCompetitorList();
    });
    
    async function editCompetitor(id) {
        openDbPanel();
        const competitor = allDbCompetitors.find(c => c.id === id);
        if (!competitor) return;
        document.getElementById('competitorId').value = competitor.id;
        document.getElementById('competitorName').value = competitor.name;
        document.getElementById('birthDate').value = competitor.birthDate || '';
        document.getElementById('residence').value = competitor.residence || '';
        document.getElementById('height').value = competitor.height || '';
        document.getElementById('weight').value = competitor.weight || '';
        document.getElementById('competitorNotes').value = competitor.notes || '';
        document.getElementById('category').value = competitor.category || 'Lokalny';
        document.getElementById('competitorFormBtn').textContent = 'Zapisz zmiany';
    }
    
    async function confirmDeleteCompetitor(id) {
        if (await showConfirmation("Czy na pewno chcesz usunąć tego zawodnika z bazy? Ta operacja jest nieodwracalna.")) {
            await deleteCompetitorFromDb(id);
            showNotification("Zawodnik został usunięty.", "success");
            await renderDbCompetitorList();
            await populateFullCompetitorList();
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    
    function showCompetitorDetails(name) {
        const profile = competitorProfiles[name];
        if (!profile) return;
        document.getElementById('competitorDetailName').textContent = name;
        document.getElementById('competitorDetailPhoto').src = profile.photo || 'https://placehold.co/150x150/eee/333?text=?';
        const metaContainer = document.getElementById('competitorDetailMeta');
        metaContainer.innerHTML = `
            <p><strong>Kategoria:</strong> ${profile.category || 'Brak'}</p>
            <p><strong>Mieszka:</strong> ${profile.residence || 'Brak danych'}</p>
            <p><strong>Wzrost:</strong> ${profile.height ? profile.height + ' cm' : 'Brak danych'}</p>
            <p><strong>Waga:</strong> ${profile.weight ? profile.weight + ' kg' : 'Brak danych'}</p>
        `;
        document.getElementById('competitorDetailNotes').textContent = profile.notes || 'Brak dodatkowych informacji.';
        document.getElementById('competitorDetailModal').classList.add('visible');
    }

    // --- UI & NOTIFICATIONS ---
    function showNotification(message, type = 'success', duration = 3000) {
        const bar = document.getElementById('notification-bar');
        const icons = { success: '✅', error: '❌', info: 'ℹ️' };
        bar.innerHTML = `${icons[type] || ''} ${message}`;
        bar.className = type; 
        bar.classList.add('show');
        setTimeout(() => bar.classList.remove('show'), duration);
    }

    function showConfirmation(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirmation-modal');
            modal.querySelector('#modal-text').textContent = message;
            modal.classList.add('visible');
            const confirmBtn = modal.querySelector('#confirmBtn');
            const cancelBtn = modal.querySelector('#cancelBtn');
            const close = (value) => { modal.classList.remove('visible'); confirmBtn.onclick = null; cancelBtn.onclick = null; resolve(value); };
            confirmBtn.onclick = () => close(true);
            cancelBtn.onclick = () => close(false);
        });
    }

    function showPrompt(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('prompt-modal');
            modal.querySelector('#prompt-text').textContent = message;
            modal.classList.add('visible');
            const input = modal.querySelector('#promptInput');
            input.value = '';
            input.focus();
            const confirmBtn = modal.querySelector('#promptConfirmBtn');
            const cancelBtn = modal.querySelector('#promptCancelBtn');
            const close = (value) => { modal.classList.remove('visible'); confirmBtn.onclick = null; cancelBtn.onclick = null; resolve(value); };
            confirmBtn.onclick = () => close(input.value);
            cancelBtn.onclick = () => close(null);
            input.onkeydown = (e) => { if (e.key === 'Enter') close(input.value); };
        });
    }

    // --- STATE MANAGEMENT ---
    function getCurrentState(includeResults = true) {
      const state = {
        competitors: JSON.parse(JSON.stringify(competitors)), 
        scores: JSON.parse(JSON.stringify(scores)),
        eventNumber, 
        eventHistory: JSON.parse(JSON.stringify(eventHistory)), 
        logoData, 
        currentEventType,
        eventTitle: document.getElementById('eventTitle')?.textContent || `Konkurencja ${eventNumber}`,
        eventName: document.getElementById('eventName').value,
        eventLocation: document.getElementById('eventLocation').value,
        competitorProfiles: JSON.parse(JSON.stringify(competitorProfiles))
      };
      if (includeResults && document.getElementById('mainContent').style.display === 'block') {
        state.currentResults = {};
        document.querySelectorAll('.resultInput').forEach(input => {
            if(!input.readOnly) state.currentResults[input.dataset.name] = input.value;
        });
      }
      return state;
    }

    function saveToUndoHistory() {
      undoHistory.push(getCurrentState());
      redoHistory = [];
      document.getElementById('undoBtn').disabled = false;
      document.getElementById('redoBtn').disabled = true;
    }

    function restoreState(state, fromFile = false) {
      if (!state || !state.competitors) {
        showNotification("Nieprawidłowe dane do wczytania stanu.", "error");
        return;
      }
      competitors = state.competitors; 
      scores = state.scores; 
      eventNumber = state.eventNumber;
      eventHistory = state.eventHistory; 
      logoData = state.logoData; 
      currentEventType = state.currentEventType;
      competitorProfiles = state.competitorProfiles || {};
      
      document.getElementById('intro').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';

      document.getElementById('eventTitle').textContent = state.eventTitle || `Konkurencja ${eventNumber}`;
      document.getElementById('eventName').value = state.eventName || '';
      document.getElementById('eventLocation').value = state.eventLocation || '';

      if(logoData) {
        document.getElementById('logoImg').src = logoData;
        document.getElementById('selectLogoBtn').style.display = 'none';
      } else {
        removeLogo();
      }
      setEventType(currentEventType, false);
      renderTable();

      if(state.currentResults){
          Object.keys(state.currentResults).forEach(name => {
              const input = document.querySelector(`.resultInput[data-name="${CSS.escape(name)}"]`);
              if (input) input.value = state.currentResults[name];
          });
      }
       if (eventHistory.length > 0 && eventHistory[eventHistory.length-1].nr === eventNumber) {
            renderTableWithCurrentEventData(eventHistory[eventHistory.length-1].wyniki);
             document.querySelectorAll('.resultInput').forEach(input => input.readOnly = true);
        }

      if(fromFile) {
        recalculateAllPoints();
        recalculateTotalScores();
        renderTable();
        showNotification("Stan aplikacji został wczytany z pliku!", "success");
      }
    }
    
    function undoLastAction() {
      if (undoHistory.length === 0) return;
      redoHistory.push(getCurrentState());
      restoreState(undoHistory.pop());
      saveState('autoSave');
      document.getElementById('redoBtn').disabled = false;
      if (undoHistory.length === 0) document.getElementById('undoBtn').disabled = true;
    }

    function redoLastAction() {
        if (redoHistory.length === 0) return;
        undoHistory.push(getCurrentState());
        restoreState(redoHistory.pop());
        saveState('autoSave');
        document.getElementById('undoBtn').disabled = false;
        if (redoHistory.length === 0) document.getElementById('redoBtn').disabled = true;
    }

    // --- SAVE/LOAD & BACKUP SYSTEM ---
    
    function saveState(key, data) {
      try { 
        const stateToSave = data || getCurrentState();
        localStorage.setItem(`strongmanState_${key}`, JSON.stringify(stateToSave));
      } 
      catch (e) { 
        console.error("Save state error:", e);
        showNotification("Nie udało się zapisać stanu.", "error"); 
      }
    }

    async function loadState(key) {
      const savedStateJSON = localStorage.getItem(key);
      if (!savedStateJSON) {
        if(key !== 'strongmanState_autoSave') showNotification("Nie znaleziono zapisu.", "info");
        return false;
      }

      const checkpointName = key.startsWith('strongmanState_checkpoint-') 
        ? `"${key.replace('strongmanState_checkpoint-', '')}"` 
        : "ostatniej sesji";
      let promptMessage = `Czy chcesz przywrócić ${checkpointName}? Spowoduje to utratę niezapisanych zmian.`;

      if (await showConfirmation(promptMessage)) {
        try {
          await populateFullCompetitorList();
          restoreState(JSON.parse(savedStateJSON));
          undoHistory = []; redoHistory = [];
          document.getElementById('undoBtn').disabled = true;
          document.getElementById('redoBtn').disabled = true;
          showNotification(`Wczytano ${checkpointName}!`, "success");
          return true;
        } catch (error) {
          console.error("Load state error:", error);
          showNotification("Błąd przy wczytywaniu zapisu. Zapis mógł być uszkodzony.", "error");
          localStorage.removeItem(key); 
          return false;
        }
      } else {
        if(key === 'strongmanState_autoSave') {
             localStorage.removeItem('strongmanState_autoSave');
        }
        return false;
      }
    }

    function triggerAutoSave() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            if(document.getElementById('mainContent').style.display === 'block') {
                saveState('autoSave');
                const indicator = document.getElementById('saveIndicator');
                indicator.classList.add('visible');
                setTimeout(() => indicator.classList.remove('visible'), 1500);
            }
        }, 2000);
    }

    async function saveCheckpoint() {
        const name = await showPrompt("Podaj nazwę dla punktu kontrolnego (np. 'Po walizkach'):");
        if(name && name.trim()) {
            saveState(`checkpoint-${name.trim()}`);
            showNotification(`Punkt kontrolny "${name.trim()}" został zapisany!`, 'success');
            document.getElementById('checkpointListContainer').style.display = 'none';
        }
    }

    function getCheckpoints() {
        const checkpoints = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('strongmanState_checkpoint-')) {
                const name = key.replace('strongmanState_checkpoint-', '');
                checkpoints[name] = key;
            }
        }
        return checkpoints;
    }

    function showCheckpoints() {
        const container = document.getElementById('checkpointListContainer');
        const list = document.getElementById('checkpointList');
        const checkpoints = getCheckpoints();
        
        container.style.display = 'block';
        if (Object.keys(checkpoints).length === 0) {
            list.innerHTML = '<p>Brak zapisanych punktów kontrolnych.</p>';
            return;
        }
        
        list.innerHTML = '';
        for (const name in checkpoints) {
            const key = checkpoints[name];
            const btn = document.createElement('button');
            btn.textContent = `Wczytaj: ${name}`;
            btn.onclick = () => loadState(key);
            list.appendChild(btn);
        }
    }

    function exportStateToFile() {
        const state = getCurrentState();
        const stateJson = JSON.stringify(state, null, 2);
        const blob = new Blob([stateJson], { type: 'application/json' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        const eventName = document.getElementById('eventName').value.replace(/ /g, '_') || 'zawody';
        link.download = `strongman_backup_${eventName}_${new Date().toISOString().slice(0,10)}.json`;
        link.click();
        URL.revokeObjectURL(link.href);
    }

    function importStateFromFile() { 
      if (document.getElementById('mainContent').style.display === 'block') {
        document.getElementById('importFile2').click();
      } else {
        document.getElementById('importFile').click();
      }
    }

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const state = JSON.parse(e.target.result);
                if (await showConfirmation("Czy na pewno chcesz zaimportować stan z pliku? Spowoduje to nadpisanie obecnego stanu.")) {
                    await populateFullCompetitorList();
                    restoreState(state, true);
                }
            } catch (error) { showNotification("Błąd: Nieprawidłowy format pliku.", "error"); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    
    // --- CORE COMPETITION LOGIC ---
    
    function showEditableResults(eventNr) {
      const eventToEdit = eventHistory.find(e => e.nr === eventNr);
      if (!eventToEdit) return;
      const details = document.getElementById("eventDetails");
      let html = `<h4>Edytujesz: ${eventToEdit.name}</h4><table id="editTable_${eventNr}"><tr><th>Zawodnik</th><th>Wynik</th></tr>`;
      eventToEdit.wyniki.forEach(w => {
        html += `<tr><td>${w.name}</td><td><input class="editable-result" data-name="${w.name}" value="${w.wynik}"></td></tr>`;
      });
      html += `</table><button onclick="saveAndRecalculate(${eventNr})">Zapisz i przelicz wszystko</button>`;
      details.innerHTML = html;
    }

    function saveAndRecalculate(eventNr) {
      saveToUndoHistory(); 
      const eventToUpdate = eventHistory.find(e => e.nr === eventNr);
      if (!eventToUpdate) return;
      const editedInputs = document.querySelectorAll(`#editTable_${eventNr} .editable-result`);
      editedInputs.forEach(input => {
        const resultToUpdate = eventToUpdate.wyniki.find(w => w.name === input.dataset.name);
        if(resultToUpdate) resultToUpdate.wynik = input.value;
      });
      recalculateAllPoints();
      recalculateTotalScores();
      renderTable();
      showResults();
      document.getElementById("eventDetails").innerHTML = '<p style="text-align:center; color:green;">Wyniki zostały przeliczone!</p>';
      saveState('autoSave');
      showNotification('Wyniki zostały pomyślnie przeliczone!', 'success');
    }
    
    function recalculateAllPoints() {
        eventHistory.forEach(event => {
            const results = event.wyniki.map(w => ({ name: w.name, val: (w.wynik === "0" || w.wynik === "") ? -Infinity : parseFloat(String(w.wynik).replace(',', '.')), zero: (w.wynik === "0" || w.wynik === "") }));
            results.sort((a, b) => event.typ === 'high' ? b.val - a.val : a.val - b.val);
            const total = competitors.length;
            for (let i = 0; i < results.length; ) {
              let j = i;
              while (j < results.length && results[j].val === results[i].val) j++;
              const tiedCount = j - i;
              let sumPts = 0;
              for (let k = i; k < j; k++) if (!results[k].zero) sumPts += (total - k);
              const avgPts = tiedCount > 0 ? sumPts / tiedCount : 0;
              for (let k = i; k < j; k++) {
                const resultToUpdate = event.wyniki.find(w => w.name === results[k].name);
                resultToUpdate.punkty = (results[k].zero ? 0 : avgPts).toFixed(2);
                resultToUpdate.miejsce = results[k].zero ? "-" : (i + 1);
              }
              i = j;
            }
        });
    }

    function recalculateTotalScores() {
        Object.keys(scores).forEach(name => scores[name] = 0);
        eventHistory.forEach(event => {
            event.wyniki.forEach(result => {
                if (scores[result.name] !== undefined) {
                    scores[result.name] += parseFloat(result.punkty);
                }
            });
        });
    }

    function setEventType(type, recordUndo = true) {
      if(recordUndo && currentEventType !== type) saveToUndoHistory();
      currentEventType = type;
      document.getElementById('highTypeBtn').classList.toggle('active', type === 'high');
      document.getElementById('lowTypeBtn').classList.toggle('active', type === 'low');
      triggerAutoSave();
    }
    
    function startCompetition() {
      const selectedInputs = document.querySelectorAll('#competitorSelectionList input:checked');
      competitors = Array.from(selectedInputs).map(input => input.value);
      
      if (competitors.length < 2) { showNotification("Wybierz co najmniej dwóch zawodników.", "error"); return; }
      scores = {};
      competitors.forEach(name => { scores[name] = 0; });
      eventNumber = 1; eventHistory = []; undoHistory = []; redoHistory = [];
      document.getElementById('undoBtn').disabled = true;
      document.getElementById('redoBtn').disabled = true;
      document.getElementById("intro").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      renderTable();
      saveState('autoSave');
    }

    function renderTable() {
      const tbody = document.querySelector("#resultsTable tbody");
      tbody.innerHTML = competitors.map(name => {
        const profile = competitorProfiles[name] || {};
        return `
        <tr data-name="${name}">
          <td>
            <div class="competitor-cell">
              <img src="${profile.photo || 'https://placehold.co/40x40/eee/333?text=?'}" class="competitor-photo-thumb" alt="${name}">
              <span>${name}</span>
              <span class="info-icon" onclick="showCompetitorDetails('${name}')" aria-label="Pokaż szczegóły zawodnika">ℹ️</span>
            </div>
          </td>
          <td><input class="resultInput" data-name="${name}" type="text" inputmode="decimal" /></td>
          <td data-type="place">-</td>
          <td data-type="points">0.00</td>
          <td data-type="sum">${(scores[name] || 0).toFixed(2)}</td>
        </tr>
      `}).join('');
      document.querySelectorAll('.resultInput').forEach(input => {
        input.addEventListener('input', triggerAutoSave);
      });
    }

    function shuffleCompetitors() {
      saveToUndoHistory();
      for (let i = competitors.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [competitors[i], competitors[j]] = [competitors[j], competitors[i]];
      }
      renderTable(); 
      triggerAutoSave();
    }

    function calculatePoints() {
      saveToUndoHistory();
      try {
        const inputs = [...document.querySelectorAll('.resultInput')];
        const eventName = document.getElementById('eventTitle').textContent;
        let hasError = false;
        inputs.forEach(input => {
            const valStr = input.value.trim().replace(',', '.');
            if (valStr !== '' && isNaN(valStr)) { input.style.borderColor = 'red'; hasError = true; } 
            else { input.style.borderColor = ''; }
        });
        if (hasError) { throw new Error("Invalid number"); }
        
        const results = inputs.map(input => {
            const valStr = input.value.trim().replace(',', '.');
            return { name: input.dataset.name, val: (valStr === "0" || valStr === "") ? -Infinity : parseFloat(valStr), raw: input.value.trim(), zero: (valStr === "0" || valStr === "") };
        });

        results.sort((a, b) => currentEventType === 'high' ? b.val - a.val : a.val - b.val);
        let eventResults = [];
        const total = competitors.length;
        for (let i = 0; i < results.length; ) {
          let j = i;
          while (j < results.length && results[j].val === results[i].val) j++;
          const tiedCount = j - i;
          let sumPts = 0;
          for (let k = i; k < j; k++) if (!results[k].zero) sumPts += (total - k);
          const avgPts = tiedCount > 0 ? sumPts / tiedCount : 0;
          for (let k = i; k < j; k++) {
            eventResults.push({ name: results[k].name, wynik: results[k].raw, miejsce: results[k].zero ? "-" : (i + 1), punkty: (results[k].zero ? 0 : avgPts).toFixed(2) });
          }
          i = j;
        }

        eventHistory.push({ nr: eventNumber, name: eventName, typ: currentEventType, wyniki: eventResults });
        recalculateTotalScores();
        renderTableWithCurrentEventData(eventResults);
        inputs.forEach(input => input.readOnly = true);
        document.querySelectorAll('td[data-type="points"], td[data-type="sum"]').forEach(cell => {
            cell.classList.add('highlight-flash');
            cell.addEventListener('animationend', () => cell.classList.remove('highlight-flash'), { once: true });
        });
        triggerAutoSave();
      } catch (error) {
        showNotification("Wprowadź poprawne wartości liczbowe. Błędne pola zaznaczono na czerwono.", "error");
      }
    }

    function renderTableWithCurrentEventData(eventResults) {
        eventResults.forEach(res => {
            const row = document.querySelector(`#resultsTable tr[data-name="${CSS.escape(res.name)}"]`);
            if(row) {
                row.querySelector('.resultInput').value = res.wynik;
                row.querySelector('td[data-type="place"]').textContent = res.miejsce;
                row.querySelector('td[data-type="points"]').textContent = res.punkty;
                row.querySelector('td[data-type="sum"]').textContent = (scores[res.name] || 0).toFixed(2);
            }
        });
    }

    function nextEvent() {
      saveToUndoHistory();
      eventNumber++;
      const lastEvent = eventHistory[eventHistory.length-1];
      const lastScores = {};
      if (lastEvent) { lastEvent.wyniki.forEach(res => { lastScores[res.name] = parseFloat(res.punkty); }); }
      competitors.sort((a, b) => (lastScores[a] || 0) - (lastScores[b] || 0));
      document.getElementById('eventTitle').textContent = "Konkurencja " + eventNumber;
      renderTable(); 
      triggerAutoSave();
    }

    function lastEvent() {
      saveToUndoHistory();
      competitors.sort((a, b) => ((scores[b] || 0) - (scores[a] || 0)) || breakTie(a, b).outcome).reverse();
      document.getElementById('eventTitle').textContent = "Finałowa kolejność";
      renderTable(); 
      triggerAutoSave();
    }

    async function resetCompetition() {
        if (await showConfirmation("Czy na pewno chcesz zresetować zawody? Spowoduje to utratę wszystkich danych (poza bazą zawodników).")) {
            localStorage.removeItem('strongmanState_autoSave');
            localStorage.removeItem('isTableExpanded');
            const checkpoints = getCheckpoints();
            for (const name in checkpoints) {
                localStorage.removeItem(checkpoints[name]);
            }

            competitors = [];
            scores = {};
            eventNumber = 1;
            eventHistory = [];
            currentEventType = 'high';
            undoHistory = [];
            redoHistory = [];

            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('intro').style.display = 'block';
            document.getElementById('finalSummaryPanel')?.remove();
            
            await populateFullCompetitorList();
            
            showNotification("Aplikacja została zresetowana.", "success");
        }
    }
    
    function showResults() {
      const panel = document.getElementById("historyPanel");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
      const list = document.getElementById("eventList");
      list.innerHTML = "";
      eventHistory.forEach(event => {
        const btn = document.createElement("button");
        btn.textContent = `Edytuj Konk. ${event.nr}: ${event.name}`;
        btn.onclick = () => showEditableResults(event.nr);
        list.appendChild(btn);
      });
      if(eventHistory.length > 0) document.getElementById("eventDetails").innerHTML = '<p style="text-align:center;">Wybierz konkurencję do edycji.</p>';
    }
    
    function breakTie(a, b) {
      const countPlaces = (name) => {
        const places = Array(competitors.length + 1).fill(0);
        eventHistory.forEach(e => {
          const result = e.wyniki.find(w => w.name === name);
          if (result && result.miejsce !== "-") {
            const place = parseInt(result.miejsce);
            if (!isNaN(place)) places[place]++;
          }
        });
        return places;
      };
      
      const aPlaces = countPlaces(a), bPlaces = countPlaces(b);
      for (let i = 1; i <= competitors.length; i++) {
        if (aPlaces[i] !== bPlaces[i]) {
            return { outcome: bPlaces[i] - aPlaces[i], reason: `więcej ${i}. miejsc` };
        }
      }

      const lastEvent = eventHistory[eventHistory.length - 1];
      if (lastEvent) {
        const aResult = lastEvent.wyniki.find(r => r.name === a);
        const bResult = lastEvent.wyniki.find(r => r.name === b);
        if (aResult && bResult && aResult.punkty !== bResult.punkty) {
          return { outcome: parseFloat(bResult.punkty) - parseFloat(aResult.punkty), reason: `lepszy wynik w ost. konk.` };
        }
      }

      return { outcome: 0, reason: "Remis nierozstrzygnięty" };
    }

    function showFinalSummary() {
        const existingPanel = document.getElementById('finalSummaryPanel');
        if (existingPanel) existingPanel.remove();
        
        const panel = document.createElement('div');
        panel.className = 'panel';
        panel.id = 'finalSummaryPanel';
        document.getElementById('mainContent').appendChild(panel);

        const finalStandings = [...competitors].sort((a, b) => {
            const scoreDiff = (scores[b] || 0) - (scores[a] || 0);
            if (scoreDiff !== 0) return scoreDiff;
            return breakTie(a, b).outcome;
        });

        let standingsData = finalStandings.map(name => ({
            name: name,
            score: (scores[name] || 0).toFixed(2),
            tieInfo: ''
        }));
        
        for (let i = 0; i < standingsData.length - 1; i++) {
            if (standingsData[i].score === standingsData[i+1].score) {
                 const tieResult = breakTie(standingsData[i].name, standingsData[i+1].name);
                 if(tieResult.reason !== "Remis nierozstrzygnięty") {
                    standingsData[i].tieInfo = `<span class="tie-info" title="${tieResult.reason}">(i)<span class="tooltip">Wygrana przez: ${tieResult.reason}</span></span>`;
                 }
            }
        }
        
        let html = `<h3>Końcowa klasyfikacja</h3><div class="table-wrapper"><table><thead><tr><th>M-ce</th><th>Zawodnik</th><th>Suma</th></tr></thead><tbody>`;
        
        standingsData.forEach((data, i) => {
            const currentPlace = i + 1;
            const medalClass = currentPlace === 1 ? "gold" : currentPlace === 2 ? "silver" : currentPlace === 3 ? "bronze" : "";
            const profile = competitorProfiles[data.name] || {};
            
            html += `<tr class="${medalClass}">
                <td>${currentPlace}</td>
                <td>
                    <div class="competitor-cell">
                        <img src="${profile.photo || 'https://placehold.co/40x40/eee/333?text=?'}" class="competitor-photo-thumb" alt="${data.name}">
                        <span>${data.name} ${data.tieInfo}</span>
                    </div>
                </td>
                <td>${data.score}</td>
            </tr>`;
        });
        
        panel.innerHTML = html + `</tbody></table></div>`;
        panel.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
    
    function handleLogoUpload(event) {
        const file = event.target.files[0]; if (!file) return;
        toBase64(file).then(data => {
            logoData = data;
            document.getElementById('logoImg').src = logoData;
            localStorage.setItem('strongmanLogo', logoData);
            document.getElementById('selectLogoBtn').style.display = 'none';
            triggerAutoSave();
        });
    }

    function removeLogo() {
        logoData = null;
        document.getElementById('logoImg').src = "";
        localStorage.removeItem('strongmanLogo');
        document.getElementById('selectLogoBtn').style.display = '';
        triggerAutoSave();
    }

    function generateExportHTML(title, bodyContent) {
        const eventName = document.getElementById('eventName').value || 'Zawody Strongman';
        const eventLocation = document.getElementById('eventLocation').value || '';
        let html = `<!DOCTYPE html><html lang="pl"><head><meta charset="utf-8"><title>${title} - ${eventName}</title><style>body{font-family:Arial,sans-serif;max-width:900px;margin:auto;padding:20px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:8px;text-align:left;border-bottom:1px solid #ddd;vertical-align:middle}th{background-color:#f5f5f5}.export-logo{max-height:80px;display:block;margin:0 auto 20px}.event-meta{text-align:center;margin-bottom:20px}h1,h2{color:#2c3e50}.gold{background-color:#fff9c4}.silver{background-color:#f5f5f5}.bronze{background-color:#ffecb3}.competitor-cell{display:flex;align-items:center;gap:10px}.competitor-photo-thumb{width:30px;height:30px;border-radius:50%;object-fit:cover}</style></head><body>`;
        if (logoData) html += `<img src="${logoData}" class="export-logo">`;
        html += `<div class="event-meta"><h1>${eventName}</h1>${eventLocation ? `<p>${eventLocation}</p>` : ''}<p>${new Date().toLocaleString()}</p></div>${bodyContent}</body></html>`;
        return html;
    }
    
    function exportResultsHTML() {
        const summaryPanel = document.getElementById('finalSummaryPanel');
        if (!summaryPanel) {
            showFinalSummary();
        }
        const panelToPrint = document.getElementById('finalSummaryPanel');
        const body = panelToPrint.innerHTML;

        const blob = new Blob([generateExportHTML('Wyniki końcowe', body)], { type: 'text/html' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = 'wyniki_strongman.html';
        link.click();
        URL.revokeObjectURL(link.href);
    }
    
    async function exportToPDF() {
        showNotification("Generowanie PDF...", "info", 5000);
        
        const printContainer = document.createElement('div');
        printContainer.id = 'pdfPrintContainer';
        printContainer.style.position = 'absolute';
        printContainer.style.left = '-9999px';
        printContainer.style.width = '900px';
        printContainer.style.background = 'white';
        printContainer.style.color = '#333';

        printContainer.innerHTML = `
            <style>
                #pdfPrintContainer { font-family: Arial, sans-serif; padding: 20px; }
                #pdfPrintContainer h1, #pdfPrintContainer h2, #pdfPrintContainer h3, #pdfPrintContainer h4 { color: #2c3e50; text-align: center; margin-top: 20px; }
                #pdfPrintContainer table { width: 100%; border-collapse: collapse; margin: 20px 0; page-break-inside: auto; }
                #pdfPrintContainer tr { page-break-inside: avoid; page-break-after: auto; }
                #pdfPrintContainer th, #pdfPrintContainer td { padding: 8px; text-align: left; border: 1px solid #ddd; word-wrap: break-word; }
                #pdfPrintContainer thead { display: table-header-group; }
                #pdfPrintContainer th { background-color: #f2f2f2; font-weight: bold; }
                #pdfPrintContainer .gold { background-color:#fff9c4 !important; }
                #pdfPrintContainer .silver { background-color:#f5f5f5 !important; }
                #pdfPrintContainer .bronze { background-color:#ffecb3 !important; }
                #pdfPrintContainer .competitor-cell { display: flex; align-items: center; gap: 10px; }
                #pdfPrintContainer .competitor-photo-thumb { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
                #pdfPrintContainer .export-logo { max-height: 80px; display: block; margin: 0 auto 20px; }
                #pdfPrintContainer .event-meta { text-align: center; margin-bottom: 20px; }
                #pdfPrintContainer .page-break { page-break-before: always; border-top: 2px dashed #ccc; margin-top: 40px; }
            </style>
        `;

        const metaDiv = document.createElement('div');
        metaDiv.className = 'event-meta';
        let metaHTML = '';
        if (logoData) metaHTML += `<img src="${logoData}" class="export-logo">`;
        metaHTML += `<h1>${document.getElementById('eventName').value || 'Zawody Strongman'}</h1>
                     ${document.getElementById('eventLocation').value ? `<p>${document.getElementById('eventLocation').value}</p>` : ''}
                     <p>Data: ${new Date().toLocaleString()}</p>`;
        metaDiv.innerHTML = metaHTML;
        printContainer.appendChild(metaDiv);
        
        if (!document.getElementById('finalSummaryPanel')) {
            showFinalSummary();
        }
        const summaryPanel = document.getElementById('finalSummaryPanel');
        if (summaryPanel) {
            const summaryClone = summaryPanel.cloneNode(true);
            printContainer.appendChild(summaryClone);
        }

        if (eventHistory.length > 0) {
            const separator = document.createElement('div');
            separator.className = 'page-break';
            printContainer.appendChild(separator);

            const historyHeader = document.createElement('h2');
            historyHeader.textContent = 'Szczegółowe Wyniki Konkurencji';
            printContainer.appendChild(historyHeader);

            eventHistory.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.innerHTML = `<h4>${event.nr}. ${event.name} (${event.typ === 'high' ? 'Więcej = lepiej' : 'Mniej = lepiej'})</h4>`;
                
                let tableHTML = '<table><thead><tr><th>M-ce</th><th>Zawodnik</th><th>Wynik</th><th>Pkt.</th></tr></thead><tbody>';
                
                const sortedWyniki = [...event.wyniki].sort((a,b) => {
                    const placeA = a.miejsce === '-' ? Infinity : parseInt(a.miejsce);
                    const placeB = b.miejsce === '-' ? Infinity : parseInt(b.miejsce);
                    return placeA - placeB;
                });

                sortedWyniki.forEach(res => {
                    tableHTML += `<tr><td>${res.miejsce}</td><td>${res.name}</td><td>${res.wynik || 'B/W'}</td><td>${res.punkty}</td></tr>`;
                });
                
                tableHTML += '</tbody></table>';
                eventDiv.innerHTML += tableHTML;
                printContainer.appendChild(eventDiv);
            });
        }
        
        document.body.appendChild(printContainer);

        try {
            const canvas = await html2canvas(printContainer, { scale: 2, useCORS: true, allowTaint: true });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const canvasAspectRatio = canvasWidth / canvasHeight;

            let renderHeight = pdfWidth / canvasAspectRatio;
            let totalRenderedHeight = 0;

            for (let y = 0; y < canvasHeight; y += (canvasWidth * (pdfHeight/pdfWidth))) {
                const pageCanvas = document.createElement('canvas');
                pageCanvas.width = canvasWidth;
                pageCanvas.height = (canvasWidth * (pdfHeight/pdfWidth));
                const pageCtx = pageCanvas.getContext('2d');
                pageCtx.drawImage(canvas, 0, y, canvasWidth, pageCanvas.height, 0, 0, pageCanvas.width, pageCanvas.height);
                
                if (y > 0) {
                    pdf.addPage();
                }
                pdf.addImage(pageCanvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
            }
            
            pdf.save(`wyniki_strongman_${new Date().toISOString().slice(0,10)}.pdf`);

        } catch (err) {
            console.error("Błąd generowania PDF:", err);
            showNotification("Błąd podczas generowania PDF. Spróbuj ponownie.", "error");
        } finally {
            document.body.removeChild(printContainer);
        }
    }


    function openFocusMode(index) {
        focusModeIndex = index;
        document.getElementById('focusModeModal').classList.add('visible');
        renderFocusModeView();
    }

    function renderFocusModeView() {
        if (focusModeIndex < 0 || focusModeIndex >= competitors.length) return;
        const name = competitors[focusModeIndex];
        const profile = competitorProfiles[name] || {};
        const tableRow = document.querySelector(`#resultsTable tr[data-name="${CSS.escape(name)}"]`);
        const tableInput = tableRow ? tableRow.querySelector('.resultInput') : null;
        document.getElementById('focusCompetitorName').textContent = name;
        document.getElementById('focusCompetitorPhoto').src = profile.photo || 'https://placehold.co/120x120/eee/333?text=?';
        const focusInput = document.getElementById('focusResultInput');
        focusInput.value = tableInput ? tableInput.value : '';
        
        setTimeout(() => { focusInput.focus(); focusInput.select(); }, 100);

        const confirmBtn = document.getElementById('focusConfirmNextBtn');
        if (focusModeIndex === competitors.length - 1) {
            confirmBtn.textContent = 'Zatwierdź i Zakończ';
            document.getElementById('focusNextBtn').disabled = true;
        } else {
            confirmBtn.textContent = 'Zatwierdź i Następny';
            document.getElementById('focusNextBtn').disabled = false;
        }
        document.getElementById('focusPrevBtn').disabled = focusModeIndex === 0;
    }

    function saveFocusInput() {
        if (focusModeIndex < 0 || focusModeIndex >= competitors.length) return;
        const name = competitors[focusModeIndex];
        const tableRow = document.querySelector(`#resultsTable tr[data-name="${CSS.escape(name)}"]`);
        if (tableRow) {
            tableRow.querySelector('.resultInput').value = document.getElementById('focusResultInput').value;
        }
        triggerAutoSave();
    }

    function closeFocusMode() {
        saveFocusInput();
        document.getElementById('focusModeModal').classList.remove('visible');
    }

    function navigateFocusMode(direction) {
        saveFocusInput();
        const newIndex = focusModeIndex + direction;
        if (newIndex >= 0 && newIndex < competitors.length) {
            focusModeIndex = newIndex;
            renderFocusModeView();
        } else if (direction === 1 && newIndex === competitors.length) {
            closeFocusMode();
        }
    }
    
    async function processPastedCompetitors() {
        const currentlyChecked = [...document.querySelectorAll('#competitorSelectionList input:checked')].map(cb => cb.value.toLowerCase());
        const pastedText = document.getElementById('pastedCompetitors').value.trim();
        if (!pastedText) { showNotification('Pole do wklejania listy jest puste.', 'error'); return; }

        const pastedNames = pastedText.split('\n').map(name => name.trim()).filter(name => name);
        let newCompetitorsAddedCount = 0;
        let existingCompetitorsCount = 0;

        for (const name of pastedNames) {
            const alreadyExistsInDb = allDbCompetitors.some(c => c.name.toLowerCase() === name.toLowerCase());
            if (!alreadyExistsInDb) {
                await addCompetitorToDb({ name: name, category: 'Lokalny', notes: 'Dodany automatycznie z listy', photo: `https://placehold.co/150x150/eee/333?text=${name.substring(0,1)}` });
                newCompetitorsAddedCount++;
            } else {
                existingCompetitorsCount++;
            }
        }

        if (newCompetitorsAddedCount > 0) {
            showNotification(`${newCompetitorsAddedCount} nowych zawodników dodano do bazy.`, 'success');
            await populateFullCompetitorList();
        }
        if (existingCompetitorsCount > 0) {
            showNotification(`${existingCompetitorsCount} zawodników z listy już było w bazie.`, 'info');
        }

        const namesToSelect = new Set([...currentlyChecked, ...pastedNames.map(n => n.toLowerCase())]);
        document.querySelectorAll('#competitorSelectionList input[type="checkbox"]').forEach(checkbox => {
            if (namesToSelect.has(checkbox.value.toLowerCase())) checkbox.checked = true;
        });
        
        document.getElementById('pastedCompetitors').value = '';
        updateSelectionCounter();
    }
    
    // --- Gemini API Functions ---
    async function callGemini(prompt) {
        const modal = document.getElementById('gemini-modal');
        const loading = document.getElementById('gemini-loading');
        const output = document.getElementById('gemini-output');
        
        modal.classList.add('visible');
        loading.style.display = 'block';
        output.innerHTML = '';

        if (['file:', 'content:'].includes(window.location.protocol)) {
            showNotification("Funkcje AI nie działają w plikach otwartych lokalnie. Proszę uruchomić aplikację przez serwer WWW.", "error", 10000);
            modal.classList.remove('visible');
            return null;
        }

        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{
                parts: [{ text: prompt }]
            }]
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                 const errorBody = await response.text();
                throw new Error(`Błąd API: ${response.statusText}. Treść: ${errorBody}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("Otrzymano pustą odpowiedź z API.");
            }
        } catch (error) {
            console.error("Błąd wywołania Gemini API:", error);
            showNotification("Wystąpił błąd podczas komunikacji z AI.", "error");
            return null;
        } finally {
            loading.style.display = 'none';
        }
    }
    
    async function generateCompetitionAnnouncement() {
        if(competitors.length === 0) {
            showNotification("Dodaj najpierw zawodników do konkurencji.", "error");
            return;
        }
        
        const eventTitle = document.getElementById('eventTitle').textContent;
        const eventType = currentEventType === 'high' ? "w której im więcej lub ciężej, tym lepiej" : "w której liczy się jak najkrótszy czas";
        const competitorList = competitors.join(', ');

        const prompt = `Jesteś profesjonalnym spikerem na zawodach siłaczy. Stwórz krótką, ale porywającą i pełną energii zapowiedź dla konkurencji o nazwie "${eventTitle}". Jest to konkurencja, ${eventType}. Do rywalizacji staną następujący zawodnicy: ${competitorList}. Twoim celem jest rozgrzanie publiczności i zachęcenie do głośnego dopingu. Zakończ zapowiedź okrzykiem motywującym!`;

        const announcement = await callGemini(prompt);
        if (announcement) {
            const outputDiv = document.getElementById('gemini-output');
            outputDiv.innerHTML = `<textarea readonly>${announcement}</textarea>`;
        }
    }

    async function generateEventName() {
        const location = document.getElementById('eventLocation').value.trim();
        if (!location) {
            showNotification("Wpisz najpierw miejsce imprezy, aby nazwa była lepiej dopasowana.", "error");
            return;
        }
        
        const prompt = `Zaproponuj 5 krótkich, chwytliwych i efektownych nazw dla zawodów strongman, które odbędą się w miejscowości "${location}". Zwróć każdą nazwę w nowej linii, bez numeracji i dodatkowych znaków.`;
        
        const namesText = await callGemini(prompt);
        if (namesText) {
            const names = namesText.split('\n').filter(n => n.trim() !== '');
            const outputDiv = document.getElementById('gemini-output');
            outputDiv.innerHTML = ''; // Clear previous content
            names.forEach(name => {
                const btn = document.createElement('button');
                btn.textContent = name;
                btn.onclick = () => {
                    document.getElementById('eventName').value = name;
                    document.getElementById('gemini-modal').classList.remove('visible');
                };
                outputDiv.appendChild(btn);
            });
        }
    }

    // --- INITIALIZATION & EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        await initDB();
        await seedDatabaseIfNeeded();
        
        const themeSelector = document.getElementById('themeSelector');
        const savedTheme = localStorage.getItem('strongmanTheme') || 'light';
        document.body.className = savedTheme;
        themeSelector.value = savedTheme;
        
        themeSelector.addEventListener('change', () => {
          const theme = themeSelector.value;
          document.body.className = theme;
          localStorage.setItem('strongmanTheme', theme);
        });

        const loadedFromAutoSave = await loadState('strongmanState_autoSave');

        if (!loadedFromAutoSave) {
            await populateFullCompetitorList();
            const savedLogo = localStorage.getItem('strongmanLogo');
            if (savedLogo) {
                document.getElementById('logoImg').src = savedLogo;
                logoData = savedLogo;
                document.getElementById('selectLogoBtn').style.display = 'none';
            }
            const savedEventMeta = localStorage.getItem('eventMeta');
            if (savedEventMeta) {
              const meta = JSON.parse(savedEventMeta);
              document.getElementById('eventName').value = meta.name || '';
              document.getElementById('eventLocation').value = meta.location || '';
            }
        }
      } catch (e) {
        console.error("Initialization failed:", e);
        showNotification("Wystąpił krytyczny błąd podczas inicjalizacji.", "error", 5000);
      }
      
      const saveMeta = () => { localStorage.setItem('eventMeta', JSON.stringify({ name: document.getElementById('eventName').value, location: document.getElementById('eventLocation').value })); };
      document.getElementById('eventName').addEventListener('input', saveMeta);
      document.getElementById('eventLocation').addEventListener('input', saveMeta);
      document.getElementById('eventTitle').addEventListener('input', triggerAutoSave);
      
      document.getElementById('mainContent').addEventListener('click', (e) => {
        if (e.target.classList.contains('resultInput') && !e.target.readOnly) {
            const competitorName = e.target.dataset.name;
            const competitorIndex = competitors.findIndex(c => c === competitorName);
            if (competitorIndex !== -1) { openFocusMode(competitorIndex); }
        }
      });
      
      document.getElementById('closeFocusBtn').addEventListener('click', closeFocusMode);
      document.getElementById('focusModeModal').addEventListener('click', (e) => { if (e.target.id === 'focusModeModal') { closeFocusMode(); } });
      document.getElementById('focusPrevBtn').addEventListener('click', () => navigateFocusMode(-1));
      document.getElementById('focusNextBtn').addEventListener('click', () => navigateFocusMode(1));
      document.getElementById('focusConfirmNextBtn').addEventListener('click', () => {
          saveFocusInput();
          if (focusModeIndex === competitors.length - 1) { closeFocusMode(); } 
          else { navigateFocusMode(1); }
      });
      document.getElementById('focusResultInput').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); document.getElementById('focusConfirmNextBtn').click(); }
      });
      document.getElementById('categoryFilters').addEventListener('click', (e) => {
        if(e.target.classList.contains('filter-btn')) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            filterCompetitorSelectionList(e.target.dataset.filter);
        }
      });
      document.getElementById('addPastedBtn').addEventListener('click', processPastedCompetitors);

      const searchInput = document.getElementById('competitorSearch');
      const searchResultsContainer = document.getElementById('competitorSearchResults');
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        searchResultsContainer.innerHTML = '';
        if (query.length < 1) { searchResultsContainer.style.display = 'none'; return; }
        
        searchResultsContainer.style.display = 'block';
        const matches = allDbCompetitors.filter(c => c.name.toLowerCase().includes(query));
        if (matches.length === 0) {
            searchResultsContainer.innerHTML = '<div class="search-result-item">Brak wyników</div>';
        } else {
            matches.forEach(c => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = c.name;
                item.onclick = () => {
                    const checkbox = document.querySelector(`#competitorSelectionList input[value="${CSS.escape(c.name)}"]`);
                    if(checkbox) checkbox.checked = true;
                    searchInput.value = '';
                    searchResultsContainer.style.display = 'none';
                    updateSelectionCounter();
                };
                searchResultsContainer.appendChild(item);
            });
        }
      });
      
      document.addEventListener('click', function (e) {
          const searchContainer = document.getElementById('competitorSearchContainer');
          if (!searchContainer.contains(e.target)) {
              searchResultsContainer.style.display = 'none';
          }

          const info = e.target.closest('.tie-info');
          if (info) {
              e.preventDefault();
              info.classList.toggle('tooltip-active');
              document.querySelectorAll('.tie-info.tooltip-active').forEach(otherInfo => {
                  if (otherInfo !== info) {
                      otherInfo.classList.remove('tooltip-active');
                  }
              });
              setTimeout(() => {
                  info.classList.remove('tooltip-active');
              }, 4000);
          } else {
              document.querySelectorAll('.tie-info.tooltip-active').forEach(el => el.classList.remove('tooltip-active'));
          }
      });

      document.getElementById('logoImg').addEventListener('dblclick', async () => {
        if (!logoData) { return; }
        if (await showConfirmation("Czy na pewno chcesz usunąć to logo?")) {
            removeLogo();
        }
      });

      const toggleBtn = document.getElementById('toggleTableWidthBtn');
      const tableWrapper = document.querySelector('.table-wrapper');
      
      const isTableExpanded = localStorage.getItem('isTableExpanded') === 'true';
      if (isTableExpanded) {
          tableWrapper.classList.add('expanded');
          toggleBtn.textContent = 'Zmniejsz tabelę';
      } else {
          toggleBtn.textContent = 'Pokaż pełną tabelę';
      }

      toggleBtn.addEventListener('click', () => {
          tableWrapper.classList.toggle('expanded');
          const isNowExpanded = tableWrapper.classList.contains('expanded');
          localStorage.setItem('isTableExpanded', isNowExpanded);
          toggleBtn.textContent = isNowExpanded ? 'Zmniejsz tabelę' : 'Pokaż pełną tabelę';
      });

      // Gemini feature listeners
      document.getElementById('generateAnnounceBtn').addEventListener('click', generateCompetitionAnnouncement);
      document.getElementById('generateEventNameBtn').addEventListener('click', generateEventName);
      document.getElementById('geminiCloseBtn').addEventListener('click', () => {
          document.getElementById('gemini-modal').classList.remove('visible');
      });

      // Mobile keyboard fix for focus mode
      const focusInput = document.getElementById('focusResultInput');
      const focusModalOverlay = document.getElementById('focusModeModal');
      focusInput.addEventListener('focus', () => {
        if (window.innerWidth <= 768) {
          focusModalOverlay.classList.add('keyboard-active');
        }
      });
      focusInput.addEventListener('blur', () => {
        focusModalOverlay.classList.remove('keyboard-active');
      });

    });
  </script>
</body>
</html>